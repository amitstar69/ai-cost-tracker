<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI Cost Tracker v3.0</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
    body { font-family: Inter, sans-serif; }

    /* Accent color */
    :root {
        --accent: #14b8a6; /* teal-500 */
        --accent-dark: #0f766e; /* teal-700 */
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(6px);
        z-index: 2000;
        align-items: center;
        justify-content: center;
    }
    .modal.active { display: flex; }

    /* Smooth fade */
    .fade { animation: fade 0.25s ease-out; }
    @keyframes fade {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
</head>

<body class="bg-gray-950 text-white">

<!-- HEADER -->
<header class="bg-gradient-to-r from-gray-900 to-gray-800 border-b border-gray-700 px-6 py-5">
    <div class="max-w-5xl mx-auto flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold">AI Cost Tracker v3.0</h1>
            <p class="text-gray-400 text-sm">Minimal. Private. Fast.</p>
        </div>
        <div class="flex gap-3">
            <button onclick="exportData()" class="px-4 py-2 bg-gray-800 rounded hover:bg-gray-700">
                Export
            </button>
            <button onclick="openSettings()" class="px-4 py-2 bg-gray-800 rounded hover:bg-gray-700">
                ‚öôÔ∏è
            </button>
        </div>
    </div>
</header>

<!-- MAIN -->
<div class="max-w-5xl mx-auto px-6 py-10">

    <!-- Empty State -->
    <div id="emptyState" class="text-center py-20">
        <div class="text-5xl mb-4">üöÄ</div>
        <h2 class="text-3xl font-semibold mb-2">Welcome</h2>
        <p class="text-gray-400 mb-6">
            Add an API key to begin tracking usage & costs.
        </p>
        <button onclick="openAddModal()"
            class="px-8 py-3 rounded bg-[var(--accent)] hover:bg-[var(--accent-dark)] text-black font-semibold">
            + Add API Key
        </button>
        <p class="text-xs text-gray-500 mt-3">Keys never leave your browser.</p>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="space-y-10 hidden">

        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-gray-900 rounded p-5 border border-gray-700">
                <div class="text-gray-400 text-sm">Today</div>
                <div id="todayCost" class="text-xl font-bold mt-1">$0.00</div>
                <div id="todayRequests" class="text-xs text-gray-500 mt-1">0 requests</div>
            </div>

            <div class="bg-gray-900 rounded p-5 border border-gray-700">
                <div class="text-gray-400 text-sm">This Week</div>
                <div id="weekCost" class="text-xl font-bold mt-1">$0.00</div>
                <div id="weekRequests" class="text-xs text-gray-500 mt-1">0 requests</div>
            </div>

            <div class="bg-gray-900 rounded p-5 border border-gray-700">
                <div class="text-gray-400 text-sm">This Month</div>
                <div id="monthCost" class="text-xl font-bold mt-1">$0.00</div>
                <div id="monthRequests" class="text-xs text-gray-500 mt-1">0 requests</div>
            </div>

            <div class="bg-gray-900 rounded p-5 border border-gray-700">
                <div class="text-gray-400 text-sm">All Time</div>
                <div id="allTimeCost" class="text-xl font-bold mt-1">$0.00</div>
                <div id="allTimeRequests" class="text-xs text-gray-500 mt-1">0 requests</div>
            </div>
        </div>

        <!-- Connected APIs -->
        <div class="bg-gray-900 rounded p-6 border border-gray-800">
            <div class="flex justify-between mb-4">
                <h3 class="text-lg font-semibold">Connected APIs</h3>
                <button onclick="openAddModal()"
                    class="px-3 py-2 rounded bg-[var(--accent)] text-black font-semibold hover:bg-[var(--accent-dark)]">
                    + Add
                </button>
            </div>
            <div id="apiList" class="space-y-3">
                <p class="text-gray-500 text-center py-6">No APIs yet</p>
            </div>
        </div>

        <!-- Playground -->
        <div class="bg-gray-900 rounded p-6 border border-gray-800">
            <h3 class="text-lg font-semibold mb-4">Playground</h3>

            <label class="text-sm text-gray-400">Provider & Model</label>
            <select id="modelSelect" class="w-full mt-1 mb-4 bg-gray-800 rounded px-3 py-2">
                <option value="">-- Select --</option>
            </select>

            <label class="text-sm text-gray-400">Message</label>
            <textarea id="promptInput" rows="4"
                class="w-full mt-1 bg-gray-800 rounded px-3 py-2 mb-4"></textarea>

            <div class="flex justify-between items-center mb-4">
                <div class="text-sm">
                    <span class="text-gray-400">Estimated:</span>
                    <span id="estimatedCost" class="text-teal-400">$0.0000</span>
                </div>

                <button id="sendBtn" onclick="sendMessage()"
                    class="px-6 py-2 bg-[var(--accent)] text-black rounded font-semibold hover:bg-[var(--accent-dark)]">
                    Send ‚Üí
                </button>
            </div>

            <div id="responseBox" class="hidden">
                <pre id="responseText" class="whitespace-pre-wrap bg-gray-800 p-4 rounded text-gray-300"></pre>
                <div class="grid grid-cols-3 mt-3 gap-4 text-center">
                    <div>
                        <div class="text-gray-500 text-xs">Input</div>
                        <div id="inputTokens" class="font-bold">0</div>
                    </div>
                    <div>
                        <div class="text-gray-500 text-xs">Output</div>
                        <div id="outputTokens" class="font-bold">0</div>
                    </div>
                    <div>
                        <div class="text-gray-500 text-xs">Cost</div>
                        <div id="actualCost" class="font-bold text-teal-400">$0.0000</div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Add Provider Modal -->
<div id="addModal" class="modal">
<div class="bg-gray-900 p-6 rounded w-full max-w-md border border-gray-700 fade">
    <h2 class="text-xl font-bold mb-4">Add API Provider</h2>

    <label class="text-sm text-gray-300">Provider</label>
    <select id="providerType" class="w-full bg-gray-800 rounded px-3 py-2 mb-4"
        onchange="updateProviderFields()">
        <option value="openai">OpenAI</option>
        <option value="anthropic">Anthropic</option>
        <option value="gemini">Gemini</option>
        <option value="custom">Custom</option>
    </select>

    <div id="modelFields"></div>

    <label class="text-sm text-gray-300">API Key</label>
    <input id="apiKeyInput" type="password" class="w-full bg-gray-800 rounded px-3 py-2 mb-4">

    <label class="text-sm text-gray-300">Nickname (optional)</label>
    <input id="nicknameInput" class="w-full bg-gray-800 rounded px-3 py-2 mb-6">

    <div class="flex gap-3">
        <button onclick="closeAddModal()" class="flex-1 py-2 bg-gray-700 rounded">Cancel</button>
        <button onclick="saveProvider()" class="flex-1 py-2 bg-[var(--accent)] text-black font-semibold rounded">
            Save
        </button>
    </div>
</div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
<div class="bg-gray-900 p-6 rounded w-full max-w-md border border-gray-700 fade">
    <h2 class="text-xl font-bold mb-4">Settings</h2>

    <button onclick="clearAll()" class="w-full py-2 bg-red-600 rounded mb-4">Clear All Data</button>

    <div class="text-gray-500 text-center text-sm">
        AI Cost Tracker v3.0  
        <br />Private. Local. Zero Backend.
    </div>

    <button onclick="closeSettings()" class="w-full mt-5 py-2 bg-gray-800 rounded">
        Close
    </button>
</div>
</div>

<script>
/* -----------------------------
   Storage Helpers
----------------------------- */
const load = k => JSON.parse(localStorage.getItem(k) || "[]");
const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

/* -----------------------------
   Init
----------------------------- */
document.addEventListener("DOMContentLoaded", () => {
    updateUI();
    updateProviderFields();
});

/* -----------------------------
   Provider Modal Logic
----------------------------- */
function openAddModal(){ document.getElementById("addModal").classList.add("active"); }
function closeAddModal(){ document.getElementById("addModal").classList.remove("active"); }

function updateProviderFields(){
    const type = document.getElementById("providerType").value;
    const box = document.getElementById("modelFields");

    if(type === "openai"){
        box.innerHTML = `
            <label class="text-sm text-gray-300">Model</label>
            <select id="modelInput" class="w-full bg-gray-800 rounded px-3 py-2 mb-4">
                <option>gpt-4o</option>
                <option>gpt-4o-mini</option>
                <option>gpt-4-turbo</option>
            </select>
        `;
    }
    else if(type === "anthropic"){
        box.innerHTML = `
            <label class="text-sm text-gray-300">Model</label>
            <select id="modelInput" class="w-full bg-gray-800 rounded px-3 py-2 mb-4">
                <option>claude-3-sonnet</option>
                <option>claude-3-haiku</option>
            </select>
        `;
    }
    else if(type === "gemini"){
        box.innerHTML = `
            <label class="text-sm text-gray-300">Model</label>
            <select id="modelInput" class="w-full bg-gray-800 rounded px-3 py-2 mb-4">
                <option>gemini-1.5-flash</option>
                <option>gemini-1.5-pro</option>
            </select>
        `;
    }
    else{
        box.innerHTML = `
            <label class="text-sm text-gray-300">Custom Endpoint</label>
            <input id="endpointInput" class="w-full bg-gray-800 rounded px-3 py-2 mb-4">

            <label class="text-sm text-gray-300">Model</label>
            <input id="modelInput" class="w-full bg-gray-800 rounded px-3 py-2 mb-4">

            <label class="text-sm text-gray-300">Input Cost (per M tokens)</label>
            <input id="costIn" type="number" class="w-full bg-gray-800 rounded px-3 py-2 mb-4">

            <label class="text-sm text-gray-300">Output Cost (per M tokens)</label>
            <input id="costOut" type="number" class="w-full bg-gray-800 rounded px-3 py-2 mb-4">
        `;
    }
}

/* -----------------------------
   Save Provider
----------------------------- */
function saveProvider(){
    const type = document.getElementById("providerType").value;
    const key = document.getElementById("apiKeyInput").value.trim();
    if(!key){ alert("Enter API key"); return;}

    let p = {
        id: Date.now().toString(),
        type,
        key,
        nickname: document.getElementById("nicknameInput").value.trim(),
        enabled: true
    };

    if(type === "custom"){
        p.endpoint = document.getElementById("endpointInput").value;
        p.model = document.getElementById("modelInput").value;
        p.costIn = (+document.getElementById("costIn").value || 0)/1e6;
        p.costOut = (+document.getElementById("costOut").value || 0)/1e6;
    }
    else{
        p.model = document.getElementById("modelInput").value;
    }

    const list = load("providers");
    list.push(p);
    save("providers", list);

    closeAddModal();
    updateUI();
}

/* -----------------------------
   UI Updates
----------------------------- */
function updateUI(){
    const providers = load("providers");

    if(providers.length === 0){
        document.getElementById("emptyState").classList.remove("hidden");
        document.getElementById("dashboard").classList.add("hidden");
        return;
    }

    document.getElementById("emptyState").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");

    renderProviders();
    renderModelSelect();
    renderStats();
}

function renderProviders(){
    const box = document.getElementById("apiList");
    const providers = load("providers");
    const usage = load("usage");

    box.innerHTML = providers.map(p => {
        const total = usage
            .filter(u => u.pid === p.id)
            .reduce((a,b)=>a+b.cost,0)
            .toFixed(4);

        return `
            <div class="bg-gray-800 p-4 rounded border border-gray-700 flex justify-between">
                <div>
                    <div class="font-semibold">${p.nickname || p.type}</div>
                    <div class="text-xs text-gray-500">${p.model}</div>
                    <div class="text-xs text-gray-400 mt-1">$${total} total</div>
                </div>
                <button onclick="deleteProvider('${p.id}')" class="text-red-400">‚úï</button>
            </div>
        `;
    }).join("");
}

function renderModelSelect(){
    const select = document.getElementById("modelSelect");
    const providers = load("providers").filter(p => p.enabled);
    if(providers.length === 0){
        select.innerHTML = "<option>No providers enabled</option>";
        return;
    }

    select.innerHTML = "<option value=''>-- Select --</option>" + 
        providers.map(p => `
            <option value="${p.id}|${p.model}">
                ${p.nickname || p.type} ‚Äî ${p.model}
            </option>
        `).join("");
}

function renderStats(){
    const usage = load("usage");
    if(usage.length === 0){
        document.getElementById("todayCost").textContent = "$0.00";
        document.getElementById("todayRequests").textContent = "0 requests";
        document.getElementById("weekCost").textContent = "$0.00";
        document.getElementById("weekRequests").textContent = "0 requests";
        document.getElementById("monthCost").textContent = "$0.00";
        document.getElementById("monthRequests").textContent = "0 requests";
        document.getElementById("allTimeCost").textContent = "$0.00";
        document.getElementById("allTimeRequests").textContent = "0 requests";
        return;
    }

    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const weekAgo = new Date(now.getTime() - 7*86400000);
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

    const calc = (from) => usage.filter(u => new Date(u.time) >= from)
        .reduce((a,b)=>a+b.cost,0);

    const cnt = (from) => usage.filter(u => new Date(u.time) >= from).length;

    document.getElementById("todayCost").textContent = "$" + calc(today).toFixed(4);
    document.getElementById("todayRequests").textContent = cnt(today) + " requests";

    document.getElementById("weekCost").textContent = "$" + calc(weekAgo).toFixed(4);
    document.getElementById("weekRequests").textContent = cnt(weekAgo) + " requests";

    document.getElementById("monthCost").textContent = "$" + calc(monthStart).toFixed(4);
    document.getElementById("monthRequests").textContent = cnt(monthStart) + " requests";

    document.getElementById("allTimeCost").textContent =
        "$" + usage.reduce((a,b)=>a+b.cost,0).toFixed(4);
    document.getElementById("allTimeRequests").textContent = usage.length + " requests";
}

/* -----------------------------
   Playground
----------------------------- */
document.getElementById("promptInput").addEventListener("input", estimateCost);

function estimateCost(){
    const text = document.getElementById("promptInput").value;
    const approx = Math.ceil(text.length/4);
    const sel = document.getElementById("modelSelect").value;
    if(!sel) return;

    const [pid, model] = sel.split("|");
    const p = load("providers").find(x => x.id === pid);

    let rateIn=0, rateOut=0;

    if(p.type === "openai"){
        rateIn = 0.0025; rateOut = 0.01;
    }
    else if(p.type === "anthropic"){
        rateIn = 0.003; rateOut = 0.015;
    }
    else if(p.type === "gemini"){
        rateIn = 0.0005; rateOut = 0.0005;
    }
    else{
        rateIn = p.costIn;
        rateOut = p.costOut;
    }

    const cost = approx*rateIn + approx*2*rateOut;
    document.getElementById("estimatedCost").textContent = "$" + cost.toFixed(6);
}

/* -----------------------------
   Send Message
----------------------------- */
async function sendMessage(){
    const sel = document.getElementById("modelSelect").value;
    if(!sel) return alert("Select provider & model");
    const prompt = document.getElementById("promptInput").value.trim();
    if(!prompt) return alert("Enter a message");

    const [pid,model] = sel.split("|");
    const p = load("providers").find(x => x.id === pid);

    const responseBox = document.getElementById("responseBox");
    const sendBtn = document.getElementById("sendBtn");
    sendBtn.disabled = true;
    responseBox.classList.add("hidden");

    try{
        let res;

        if(p.type === "openai"){
            res = await callOpenAI(p.key, model, prompt);
        }
        else if(p.type === "anthropic"){
            res = await callAnthropic(p.key, model, prompt);
        }
        else if(p.type === "gemini"){
            res = await callGemini(p.key, model, prompt);
        }
        else{
            res = await callCustom(p, prompt);
        }

        // log usage
        const usage = load("usage");
        usage.push({
            pid: p.id,
            type: p.type,
            model,
            promptTokens: res.in,
            completionTokens: res.out,
            total: res.total,
            cost: res.cost,
            time: new Date().toISOString()
        });
        save("usage", usage);

        // update UI
        document.getElementById("responseText").textContent = res.text;
        document.getElementById("inputTokens").textContent = res.in;
        document.getElementById("outputTokens").textContent = res.out;
        document.getElementById("actualCost").textContent = "$" + res.cost.toFixed(6);

        responseBox.classList.remove("hidden");
        updateStats();
    }
    catch(e){
        alert("Error: " + e.message);
    }
    finally{
        sendBtn.disabled = false;
    }
}

/* -----------------------------
   Provider Callers
----------------------------- */

async function callOpenAI(key, model, prompt){
    const r = await fetch("https://api.openai.com/v1/chat/completions",{
        method:"POST",
        headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer "+key
        },
        body:JSON.stringify({
            model,
            messages:[{role:"user",content:prompt}]
        })
    });

    if(!r.ok) throw new Error("OpenAI error");
    const d = await r.json();

    const pricing = {in:0.0025, out:0.01}; 
    const cost = d.usage.prompt_tokens*pricing.in + d.usage.completion_tokens*pricing.out;

    return {
        text: d.choices[0].message.content,
        in: d.usage.prompt_tokens,
        out: d.usage.completion_tokens,
        total: d.usage.total_tokens,
        cost
    };
}

async function callAnthropic(key, model, prompt){
    const r = await fetch("https://api.anthropic.com/v1/messages",{
        method:"POST",
        headers:{
            "Content-Type":"application/json",
            "x-api-key":key,
            "anthropic-version":"2023-06-01"
        },
        body:JSON.stringify({
            model,
            max_tokens:1024,
            messages:[{role:"user",content:prompt}]
        })
    });

    if(!r.ok) throw new Error("Anthropic error");
    const d = await r.json();

    const pricing = {in:0.003, out:0.015};
    const cost = d.usage.input_tokens*pricing.in + d.usage.output_tokens*pricing.out;

    return {
        text: d.content[0].text,
        in: d.usage.input_tokens,
        out: d.usage.output_tokens,
        total: d.usage.input_tokens+d.usage.output_tokens,
        cost
    };
}

async function callGemini(key, model, prompt){
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;

    const r = await fetch(url,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            contents:[
                {role:"user",parts:[{text:prompt}]}
            ]
        })
    });

    if(!r.ok) throw new Error("Gemini error");
    const d = await r.json();

    const text = d.candidates?.[0]?.content?.parts?.[0]?.text || "";

    const approxIn = Math.ceil(prompt.length/4);
    const approxOut = Math.ceil(text.length/4);
    const pricing = {in:0.0005, out:0.0005};
    const cost = approxIn*pricing.in + approxOut*pricing.out;

    return {
        text,
        in: approxIn,
        out: approxOut,
        total: approxIn+approxOut,
        cost
    };
}

async function callCustom(p, prompt){
    const r = await fetch(p.endpoint,{
        method:"POST",
        headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer "+p.key
        },
        body:JSON.stringify({
            model:p.model,
            messages:[{role:"user",content:prompt}]
        })
    });

    if(!r.ok) throw new Error("Custom API error");
    const d = await r.json();

    const text = d.choices?.[0]?.message?.content
              || d.content?.[0]?.text
              || JSON.stringify(d);

    const inTok = d.usage?.prompt_tokens || Math.ceil(prompt.length/4);
    const outTok = d.usage?.completion_tokens || Math.ceil(text.length/4);

    const cost = inTok*p.costIn + outTok*p.costOut;

    return {
        text,
        in: inTok,
        out: outTok,
        total: inTok+outTok,
        cost
    };
}

/* -----------------------------
   Settings
----------------------------- */
function openSettings(){ document.getElementById("settingsModal").classList.add("active"); }
function closeSettings(){ document.getElementById("settingsModal").classList.remove("active"); }

function clearAll(){
    if(confirm("Delete all data?")){
        localStorage.clear();
        location.reload();
    }
}

/* -----------------------------
   Export
----------------------------- */
function exportData(){
    const data = {
        providers: load("providers"),
        usage: load("usage"),
        exported: new Date().toISOString()
    };

    const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "ai-cost-tracker-export.json";
    a.click();

    URL.revokeObjectURL(url);
}

</script>

</body>
</html>
