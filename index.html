<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Cost Tracker - Monitor Your LLM Usage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-card { transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); }
        
        .toggle-switch { position: relative; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #667eea; }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); align-items: center; justify-content: center; z-index: 9999; }
        .modal.active { display: flex; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <header class="gradient-bg py-6 px-4 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center flex-wrap gap-4">
            <div class="flex items-center space-x-3">
                <div class="text-3xl">üéØ</div>
                <div>
                    <h1 class="text-2xl font-bold">AI Cost Tracker</h1>
                    <p class="text-sm text-purple-200">Monitor your LLM spending privately</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="exportData()" class="px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30 transition text-sm font-medium">üì§ Export</button>
                <button onclick="openSettings()" class="p-2 rounded-lg hover:bg-white/10 transition">‚öôÔ∏è</button>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <div id="emptyState" class="text-center py-16 fade-in">
            <div class="text-6xl mb-4">üöÄ</div>
            <h2 class="text-3xl font-bold mb-4">Welcome to AI Cost Tracker</h2>
            <p class="text-gray-400 mb-8 max-w-2xl mx-auto">Track your OpenAI, Anthropic, and custom LLM costs in real-time. Your API keys are stored only in your browser‚Äî100% private.</p>
            <button onclick="showAddApiModal()" class="px-8 py-4 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold text-lg transition shadow-lg">üîë Add Your First API Key</button>
            <p class="text-sm text-gray-500 mt-4">üîí Keys never leave your browser</p>
        </div>

        <div id="dashboard" class="space-y-6" style="display: none;">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="stat-card bg-gradient-to-br from-blue-600 to-blue-800 rounded-xl p-6 shadow-lg">
                    <div class="text-sm text-blue-200 mb-2">Today</div>
                    <div class="text-3xl font-bold" id="todayCost">$0.00</div>
                    <div class="text-xs text-blue-300 mt-2" id="todayRequests">0 requests</div>
                </div>
                <div class="stat-card bg-gradient-to-br from-purple-600 to-purple-800 rounded-xl p-6 shadow-lg">
                    <div class="text-sm text-purple-200 mb-2">This Week</div>
                    <div class="text-3xl font-bold" id="weekCost">$0.00</div>
                    <div class="text-xs text-purple-300 mt-2" id="weekRequests">0 requests</div>
                </div>
                <div class="stat-card bg-gradient-to-br from-pink-600 to-pink-800 rounded-xl p-6 shadow-lg">
                    <div class="text-sm text-pink-200 mb-2">This Month</div>
                    <div class="text-3xl font-bold" id="monthCost">$0.00</div>
                    <div class="text-xs text-pink-300 mt-2" id="monthRequests">0 requests</div>
                </div>
                <div class="stat-card bg-gradient-to-br from-green-600 to-green-800 rounded-xl p-6 shadow-lg">
                    <div class="text-sm text-green-200 mb-2">All Time</div>
                    <div class="text-3xl font-bold" id="allTimeCost">$0.00</div>
                    <div class="text-xs text-green-300 mt-2" id="allTimeRequests">0 requests</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">üîå Connected APIs</h3>
                        <button onclick="showAddApiModal()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm font-medium transition">+ Add API</button>
                    </div>
                    <div id="apiList" class="space-y-3">
                        <p class="text-gray-400 text-center py-4">No APIs connected yet</p>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">üí∞ Cost Breakdown</h3>
                    <div id="costBreakdown" class="space-y-3">
                        <p class="text-gray-400 text-center py-4">No usage data yet</p>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                <h3 class="text-xl font-semibold mb-4">üí¨ Playground - Test Your APIs</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Select Provider & Model</label>
                    <select id="modelSelect" class="w-full bg-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 outline-none">
                        <option value="">-- Select a model --</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Your Message</label>
                    <textarea id="promptInput" rows="4" class="w-full bg-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 outline-none resize-none" placeholder="Type your message here..."></textarea>
                </div>
                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                    <div class="text-sm">
                        <span class="text-gray-400">Estimated Cost:</span>
                        <span id="estimatedCost" class="text-green-400 font-semibold ml-2">$0.0000</span>
                    </div>
                    <button onclick="sendPlaygroundRequest()" id="sendButton" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">Send Message ‚Üí</button>
                </div>
                <div id="responseArea" style="display: none;">
                    <div class="bg-gray-700 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-start mb-2">
                            <div class="font-semibold">Response:</div>
                            <div class="text-sm text-gray-400" id="responseTime"></div>
                        </div>
                        <div id="responseText" class="text-gray-200 whitespace-pre-wrap"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div class="bg-gray-700 rounded-lg p-3">
                            <div class="text-gray-400 text-xs mb-1">Input Tokens</div>
                            <div class="text-xl font-bold" id="inputTokens">0</div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-3">
                            <div class="text-gray-400 text-xs mb-1">Output Tokens</div>
                            <div class="text-xl font-bold" id="outputTokens">0</div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-3">
                            <div class="text-gray-400 text-xs mb-1">Actual Cost</div>
                            <div class="text-xl font-bold text-green-400" id="actualCost">$0.0000</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="addApiModal" class="modal">
        <div class="bg-gray-800 rounded-xl p-8 max-w-2xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Add API Provider</h2>
                <button onclick="closeAddApiModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Provider Type</label>
                    <select id="providerType" onchange="updateProviderForm()" class="w-full bg-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 outline-none">
                        <option value="openai">OpenAI</option>
                        <option value="anthropic">Anthropic (Claude)</option>
                        <option value="custom">Custom LLM</option>
                    </select>
                </div>
                <div id="customProviderFields" style="display: none;" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Provider Name</label>
                        <input type="text" id="customProviderName" placeholder="e.g., Together.ai, Groq" class="w-full bg-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">API Endpoint</label>
                        <input type="text" id="customEndpoint" placeholder="https://api.example.com/v1/chat/completions" class="w-full bg-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Model Name</label>
                        <input type="text" id="customModel" placeholder="e.g., mixtral-8x7b" class="w-full bg-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Input Cost (per 1M tokens)</label>
                            <input type="number" step="0.01" id="customInputCost" placeholder="0.50" class="w-full bg-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Output Cost (per 1M tokens)</label>
                            <input type="number" step="0.01" id="customOutputCost" placeholder="1.50" class="w-full bg-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 outline-none">
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="sk-..." class="w-full bg-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Nickname (Optional)</label>
                    <input type="text" id="nicknameInput" placeholder="e.g., Work Account" class="w-full bg-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-purple-500 outline-none">
                </div>
                <div class="bg-purple-900/30 border border-purple-500/50 rounded-lg p-4 text-sm">
                    üîí <strong>Privacy:</strong> Your API key is stored only in your browser's localStorage. It never leaves your device.
                </div>
                <div class="flex space-x-3">
                    <button onclick="closeAddApiModal()" class="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-semibold transition">Cancel</button>
                    <button onclick="saveApiKey()" class="flex-1 px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition">Save API Key</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="bg-gray-800 rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Settings</h2>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <button onclick="confirmClearData()" class="w-full px-6 py-3 bg-red-600 hover:bg-red-700 rounded-lg font-semibold transition">üóëÔ∏è Clear All Data</button>
                <div class="text-sm text-gray-400 text-center">
                    <p>Version 2.0</p>
                    <p class="mt-2">Built with ‚ù§Ô∏è for privacy-conscious developers</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const PRICING = {
            openai: {
                'gpt-4o': { input: 2.50 / 1_000_000, output: 10.00 / 1_000_000 },
                'gpt-4o-mini': { input: 0.150 / 1_000_000, output: 0.600 / 1_000_000 },
                'gpt-4-turbo': { input: 10.00 / 1_000_000, output: 30.00 / 1_000_000 },
                'gpt-3.5-turbo': { input: 0.50 / 1_000_000, output: 1.50 / 1_000_000 }
            },
            anthropic: {
                'claude-sonnet-4-20250514': { input: 3.00 / 1_000_000, output: 15.00 / 1_000_000 },
                'claude-opus-4-20250514': { input: 15.00 / 1_000_000, output: 75.00 / 1_000_000 },
                'claude-haiku-4-20250305': { input: 0.80 / 1_000_000, output: 4.00 / 1_000_000 }
            }
        };

        function getData(key) { try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch { return []; } }
        function setData(key, value) { localStorage.setItem(key, JSON.stringify(value)); }

        function init() {
            const providers = getData('ai-cost-tracker-providers');
            if (providers.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('dashboard').style.display = 'none';
            } else {
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                updateDashboard();
            }
        }

        function updateDashboard() {
            updateCostCards();
            updateApiList();
            updateCostBreakdown();
            updateModelSelect();
        }

        function updateCostCards() {
            const usage = getData('ai-cost-tracker-usage');
            const now = new Date();

            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const todayUsage = usage.filter(u => new Date(u.timestamp) >= todayStart);
            const todayCost = todayUsage.reduce((sum, u) => sum + u.cost, 0);
            document.getElementById('todayCost').textContent = `$${todayCost.toFixed(4)}`;
            document.getElementById('todayRequests').textContent = `${todayUsage.length} requests`;

            const weekStart = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const weekUsage = usage.filter(u => new Date(u.timestamp) >= weekStart);
            const weekCost = weekUsage.reduce((sum, u) => sum + u.cost, 0);
            document.getElementById('weekCost').textContent = `$${weekCost.toFixed(4)}`;
            document.getElementById('weekRequests').textContent = `${weekUsage.length} requests`;

            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthUsage = usage.filter(u => new Date(u.timestamp) >= monthStart);
            const monthCost = monthUsage.reduce((sum, u) => sum + u.cost, 0);
            document.getElementById('monthCost').textContent = `$${monthCost.toFixed(4)}`;
            document.getElementById('monthRequests').textContent = `${monthUsage.length} requests`;

            const allTimeCost = usage.reduce((sum, u) => sum + u.cost, 0);
            document.getElementById('allTimeCost').textContent = `$${allTimeCost.toFixed(4)}`;
            document.getElementById('allTimeRequests').textContent = `${usage.length} requests`;
        }

        function updateApiList() {
            const providers = getData('ai-cost-tracker-providers');
            const usage = getData('ai-cost-tracker-usage');
            const list = document.getElementById('apiList');

            if (providers.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-center py-4">No APIs connected yet</p>';
                return;
            }

            list.innerHTML = providers.map(provider => {
                const providerUsage = usage.filter(u => u.providerId === provider.id);
                const providerCost = providerUsage.reduce((sum, u) => sum + u.cost, 0);
                const displayName = provider.nickname || (provider.provider === 'custom' ? provider.customName : provider.provider);
                
                return `
                    <div class="bg-gray-700 rounded-lg p-4 flex items-center justify-between">
                        <div class="flex items-center space-x-3 flex-1">
                            <div class="text-2xl">${provider.provider === 'openai' ? 'ü§ñ' : provider.provider === 'anthropic' ? 'üß†' : '‚ö°'}</div>
                            <div class="flex-1">
                                <div class="font-semibold">${displayName}</div>
                                <div class="text-sm text-gray-400">$${providerCost.toFixed(4)} total</div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <label class="toggle-switch">
                                <input type="checkbox" ${provider.enabled ? 'checked' : ''} onchange="toggleProvider('${provider.id}')">
                                <span class="slider"></span>
                            </label>
                            <button onclick="deleteProvider('${provider.id}')" class="text-red-400 hover:text-red-300">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateCostBreakdown() {
            const usage = getData('ai-cost-tracker-usage');
            const breakdown = {};

            usage.forEach(u => {
                const key = `${u.provider}-${u.model}`;
                if (!breakdown[key]) breakdown[key] = { cost: 0, count: 0, provider: u.provider, model: u.model };
                breakdown[key].cost += u.cost;
                breakdown[key].count++;
            });

            const sorted = Object.values(breakdown).sort((a, b) => b.cost - a.cost);
            const container = document.getElementById('costBreakdown');

            if (sorted.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">No usage data yet</p>';
                return;
            }

            container.innerHTML = sorted.map(item => `
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-semibold">${item.model}</div>
                            <div class="text-sm text-gray-400">${item.provider}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-green-400">$${item.cost.toFixed(4)}</div>
                            <div class="text-xs text-gray-400">${item.count} calls</div>
                        </div>
                    </div>
                    <div class="w-full bg-gray-600 rounded-full h-2">
                        <div class="bg-purple-600 h-2 rounded-full" style="width: ${(item.cost / sorted[0].cost * 100).toFixed(1)}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function updateModelSelect() {
            const providers = getData('ai-cost-tracker-providers').filter(p => p.enabled);
            const select = document.getElementById('modelSelect');

            if (providers.length === 0) {
                select.innerHTML = '<option value="">-- No APIs connected --</option>';
                return;
            }

            let options = '<option value="">-- Select a model --</option>';
            
            providers.forEach(provider => {
                if (provider.provider === 'openai') {
                    options += '<optgroup label="OpenAI">';
                    Object.keys(PRICING.openai).forEach(model => {
                        options += `<option value="${provider.id}|${model}">${model}</option>`;
                    });
                    options += '</optgroup>';
                } else if (provider.provider === 'anthropic') {
                    options += '<optgroup label="Anthropic">';
                    Object.keys(PRICING.anthropic).forEach(model => {
                        options += `<option value="${provider.id}|${model}">${model}</option>`;
                    });
                    options += '</optgroup>';
                } else if (provider.provider === 'custom') {
                    options += `<optgroup label="${provider.customName}">`;
                    options += `<option value="${provider.id}|${provider.customModel}">${provider.customModel}</option>`;
                    options += '</optgroup>';
                }
            });

            select.innerHTML = options;
        }

        function showAddApiModal() {
            document.getElementById('addApiModal').classList.add('active');
        }

        function closeAddApiModal() {
            document.getElementById('addApiModal').classList.remove('active');
            document.getElementById('providerType').value = 'openai';
            document.getElementById('apiKeyInput').value = '';
            document.getElementById('nicknameInput').value = '';
            updateProviderForm();
        }

        function updateProviderForm() {
            const type = document.getElementById('providerType').value;
            document.getElementById('customProviderFields').style.display = type === 'custom' ? 'block' : 'none';
        }

        function saveApiKey() {
            const type = document.getElementById('providerType').value;
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) { alert('Please enter an API key'); return; }

           if (type === 'openai' && !apiKey.startsWith('sk-')) {
        alert('Invalid OpenAI API key');
        return;
    }
    if (type === 'anthropic' && !apiKey.startsWith('sk-ant-') && !apiKey.startsWith('sk-')) {
        alert('Invalid Anthropic API key');
        return;
    }  const provider = {
                id: Date.now().toString(),
                provider: type,
                apiKey: apiKey,
                nickname: document.getElementById('nicknameInput').value.trim(),
                enabled: true,
                createdAt: new Date().toISOString()
            };

            if (type === 'custom') {
                const customName = document.getElementById('customProviderName').value.trim();
                const endpoint = document.getElementById('customEndpoint').value.trim();
                const model = document.getElementById('customModel').value.trim();
                if (!customName || !endpoint || !model) { alert('Please fill in all custom fields'); return; }
                provider.customName = customName;
                provider.customEndpoint = endpoint;
                provider.customModel = model;
                provider.customPricing = {
                    input: (parseFloat(document.getElementById('customInputCost').value) || 0) / 1_000_000,
                    output: (parseFloat(document.getElementById('customOutputCost').value) || 0) / 1_000_000
                };
            }

            const providers = getData('ai-cost-tracker-providers');
            providers.push(provider);
            setData('ai-cost-tracker-providers', providers);
            closeAddApiModal();
            init();
        }

        function toggleProvider(id) {
            const providers = getData('ai-cost-tracker-providers');
            const provider = providers.find(p => p.id === id);
            if (provider) {
                provider.enabled = !provider.enabled;
                setData('ai-cost-tracker-providers', providers);
                updateDashboard();
            }
        }

        function deleteProvider(id) {
            if (!confirm('Delete this API provider?')) return;
            let providers = getData('ai-cost-tracker-providers').filter(p => p.id !== id);
            setData('ai-cost-tracker-providers', providers);
            providers.length === 0 ? init() : updateDashboard();
        }

        async function sendPlaygroundRequest() {
            const select = document.getElementById('modelSelect');
            const prompt = document.getElementById('promptInput').value.trim();
            const button = document.getElementById('sendButton');

            if (!select.value) { alert('Please select a model'); return; }
            if (!prompt) { alert('Please enter a message'); return; }

            const [providerId, model] = select.value.split('|');
            const providers = getData('ai-cost-tracker-providers');
            const provider = providers.find(p => p.id === providerId);
            if (!provider) { alert('Provider not found'); return; }

            button.disabled = true;
            button.textContent = 'Sending...';
            document.getElementById('responseArea').style.display = 'none';

            const startTime = Date.now();

            try {
                let result;
                if (provider.provider === 'openai') {
                    result = await callOpenAI(provider.apiKey, model, prompt);
                } else if (provider.provider === 'anthropic') {
                    result = await callAnthropic(provider.apiKey, model, prompt);
                } else {
                    result = await callCustomAPI(provider, prompt);
                }

                const duration = ((Date.now() - startTime) / 1000).toFixed(2);

                const usage = {
                    id: Date.now().toString(),
                    providerId: provider.id,
                    provider: provider.provider === 'custom' ? provider.customName : provider.provider,
                    model: model,
                    timestamp: new Date().toISOString(),
                    promptTokens: result.promptTokens,
                    completionTokens: result.completionTokens,
                    totalTokens: result.totalTokens,
                    cost: result.cost
                };

                const usageData = getData('ai-cost-tracker-usage');
                usageData.push(usage);
                setData('ai-cost-tracker-usage', usageData);

                document.getElementById('responseText').textContent = result.response;
                document.getElementById('responseTime').textContent = `${duration}s`;
                document.getElementById('inputTokens').textContent = result.promptTokens.toLocaleString();
                document.getElementById('outputTokens').textContent = result.completionTokens.toLocaleString();
                document.getElementById('actualCost').textContent = `$${result.cost.toFixed(6)}`;
                document.getElementById('responseArea').style.display = 'block';

                updateDashboard();
            } catch (error) {
                alert(`Error: ${error.message}`);
                console.error(error);
            } finally {
                button.disabled = false;
                button.textContent = 'Send Message ‚Üí';
            }
        }

        async function callOpenAI(apiKey, model, prompt) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: 'user', content: prompt }]
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'OpenAI API request failed');
            }

            const data = await response.json();
            const pricing = PRICING.openai[model];

            return {
                response: data.choices[0].message.content,
                promptTokens: data.usage.prompt_tokens,
                completionTokens: data.usage.completion_tokens,
                totalTokens: data.usage.total_tokens,
                cost: (data.usage.prompt_tokens * pricing.input) + (data.usage.completion_tokens * pricing.output)
            };
        }

        async function callAnthropic(apiKey, model, prompt) {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: model,
                    max_tokens: 1024,
                    messages: [{ role: 'user', content: prompt }]
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Anthropic API request failed');
            }

            const data = await response.json();
            const pricing = PRICING.anthropic[model];

            return {
                response: data.content[0].text,
                promptTokens: data.usage.input_tokens,
                completionTokens: data.usage.output_tokens,
                totalTokens: data.usage.input_tokens + data.usage.output_tokens,
                cost: (data.usage.input_tokens * pricing.input) + (data.usage.output_tokens * pricing.output)
            };
        }

        async function callCustomAPI(provider, prompt) {
         // Gemini custom handling
    if ((provider.customName || '').toLowerCase().includes('gemini')) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${provider.customModel}:generateContent?key=${provider.apiKey}`;
        const body = {
            contents: [
                {
                    parts: [
                        { text: prompt }
                    ]
                }
            ]
        };
        const resp = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
        });
        if (!resp.ok) {
            const errText = await resp.text();
            throw new Error(errText || 'Gemini API request failed');
        }
        const data = await resp.json();
        const responseText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        const promptTokens = Math.ceil(prompt.length / 4);
        const completionTokens = Math.ceil(responseText.length / 4);
        return {
            response: responseText,
            promptTokens: promptTokens,
            completionTokens: completionTokens,
            totalTokens: promptTokens + completionTokens,
            cost: (promptTokens * provider.customPricing.input) + (completionTokens * provider.customPricing.output)
        };
    }
    const response = await fetch(provider.customEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${provider.apiKey}`
                },
                body: JSON.stringify({
                    model: provider.customModel,
                    messages: [{ role: 'user', content: prompt }]
                })
            });

            if (!response.ok) throw new Error('Custom API request failed');

            const data = await response.json();
            const promptTokens = data.usage?.prompt_tokens || 0;
            const completionTokens = data.usage?.completion_tokens || 0;
            const responseText = data.choices?.[0]?.message?.content || data.content?.[0]?.text || JSON.stringify(data);

            return {
                response: responseText,
                promptTokens: promptTokens,
                completionTokens: completionTokens,
                totalTokens: promptTokens + completionTokens,
                cost: (promptTokens * provider.customPricing.input) + (completionTokens * provider.customPricing.output)
            };
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function confirmClearData() {
            if (confirm('Delete all data? This cannot be undone.')) {
                localStorage.removeItem('ai-cost-tracker-providers');
                localStorage.removeItem('ai-cost-tracker-usage');
                closeSettings();
                init();
            }
        }

        function exportData() {
            const data = {
                providers: getData('ai-cost-tracker-providers').map(p => ({ ...p, apiKey: '***REDACTED***' })),
                usage: getData('ai-cost-tracker-usage'),
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai-cost-tracker-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        window.addEventListener('DOMContentLoaded', function() {
            init();
            
            const promptInput = document.getElementById('promptInput');
            if (promptInput) {
                promptInput.addEventListener('input', function() {
                    const text = this.value;
                    const approxTokens = Math.ceil(text.length / 4);
                    const select = document.getElementById('modelSelect');
                    
                    if (select && select.value) {
                        const [providerId, model] = select.value.split('|');
                        const providers = getData('ai-cost-tracker-providers');
                        const provider = providers.find(p => p.id === providerId);
                        
                        if (provider) {
                            let pricing;
                            if (provider.provider === 'openai') {
                                pricing = PRICING.openai[model];
                            } else if (provider.provider === 'anthropic') {
                                pricing = PRICING.anthropic[model];
                            } else if (provider.customPricing) {
                                pricing = provider.customPricing;
                            }
                            
                            if (pricing) {
                                const estimatedCost = approxTokens * pricing.input + (approxTokens * 2 * pricing.output);
                                const costElement = document.getElementById('estimatedCost');
                                if (costElement) {
                                    costElement.textContent = `$${estimatedCost.toFixed(6)}`;
                                }
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
