<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Cost Tracker v4.0 (CORS Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); }
        
        /* Markdown Styles */
        .prose pre { background: #1f2937; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
        .prose code { color: #e9d5ff; font-family: monospace; }
        .prose p { margin-bottom: 0.75rem; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        .prose strong { color: #fff; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen pb-20">

    <!-- Header -->
    <header class="border-b border-gray-800 bg-gray-900/50 backdrop-blur-md sticky top-0 z-30">
        <div class="max-w-5xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="text-2xl">üìâ</div>
                <div>
                    <h1 class="text-xl font-bold">AI Cost Tracker <span class="text-xs bg-purple-900 text-purple-200 px-2 py-0.5 rounded">v4.0</span></h1>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="exportData()" class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 rounded text-sm border border-gray-700">Export</button>
                <button onclick="openSettings()" class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 rounded text-sm border border-gray-700">‚öôÔ∏è</button>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-8">
        
        <!-- Stats Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-gray-900 p-5 rounded-xl border border-gray-800">
                <p class="text-gray-400 text-xs uppercase font-semibold">Today</p>
                <h3 id="statToday" class="text-2xl font-bold text-white mt-1">$0.00</h3>
            </div>
            <div class="bg-gray-900 p-5 rounded-xl border border-gray-800">
                <p class="text-gray-400 text-xs uppercase font-semibold">This Month</p>
                <h3 id="statMonth" class="text-2xl font-bold text-white mt-1">$0.00</h3>
            </div>
            <div class="bg-gray-900 p-5 rounded-xl border border-gray-800">
                <p class="text-gray-400 text-xs uppercase font-semibold">Total Tokens</p>
                <h3 id="statTokens" class="text-2xl font-bold text-purple-400 mt-1">0</h3>
            </div>
            <div class="bg-gray-900 p-5 rounded-xl border border-gray-800">
                <p class="text-gray-400 text-xs uppercase font-semibold">Requests</p>
                <h3 id="statRequests" class="text-2xl font-bold text-blue-400 mt-1">0</h3>
            </div>
        </div>

        <!-- API Providers Section -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">Your APIs</h2>
                <button onclick="openAddModal()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm font-medium flex items-center gap-2">
                    <span>+</span> Add Provider
                </button>
            </div>
            
            <div id="providerList" class="grid gap-3">
                <!-- Providers injected here -->
            </div>
            <div id="emptyProviders" class="hidden text-center py-10 border-2 border-dashed border-gray-800 rounded-xl">
                <p class="text-gray-500">No APIs connected yet.</p>
                <p class="text-gray-600 text-sm mt-1">Add OpenAI, Anthropic, or a Local LLM (Ollama) to start.</p>
            </div>
        </div>

        <!-- Playground -->
        <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-hidden shadow-2xl">
            <div class="p-4 border-b border-gray-800 bg-gray-800/50 flex justify-between items-center">
                <h2 class="font-semibold">Playground</h2>
                <div class="flex items-center gap-3">
                    <span id="estCost" class="text-xs text-gray-400 font-mono">$0.0000 est.</span>
                    <select id="activeProvider" class="bg-gray-950 border border-gray-700 rounded px-2 py-1 text-sm max-w-[200px]">
                        <option value="">Select Provider...</option>
                    </select>
                </div>
            </div>
            
            <div class="p-4">
                <textarea id="promptInput" class="w-full bg-gray-950 text-gray-200 p-4 rounded-lg border border-gray-800 focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none resize-none h-32 font-mono text-sm" placeholder="Enter your system or user prompt here..."></textarea>
                
                <div class="flex justify-end mt-3">
                    <button id="sendBtn" onclick="runPrompt()" class="px-6 py-2 bg-white text-black hover:bg-gray-200 font-semibold rounded-lg transition flex items-center gap-2">
                        Run Request
                    </button>
                </div>
            </div>

            <!-- Output Area -->
            <div id="outputArea" class="hidden border-t border-gray-800 bg-black/20 p-6">
                <div class="flex justify-between text-xs text-gray-500 mb-2 font-mono">
                    <span>Result</span>
                    <span id="runStats">0 tokens ‚Ä¢ $0.0000</span>
                </div>
                <div id="outputContent" class="prose prose-invert max-w-none text-sm text-gray-300 leading-relaxed"></div>
            </div>
        </div>

    </main>

    <!-- Add Provider Modal -->
    <div id="modalAdd" class="modal fixed inset-0 z-50 items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-gray-900 w-full max-w-md rounded-xl border border-gray-800 shadow-2xl p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">Add API Provider</h3>
            
            <label class="text-xs text-gray-400 uppercase font-bold block mb-1">Type</label>
            <select id="pType" onchange="toggleFields()" class="w-full bg-gray-950 border border-gray-700 rounded p-2.5 mb-4 text-sm">
                <option value="openai">OpenAI</option>
                <option value="anthropic">Anthropic (Requires Proxy)</option>
                <option value="gemini">Google Gemini</option>
                <option value="custom">Custom / Local (Ollama, etc)</option>
            </select>

            <label class="text-xs text-gray-400 uppercase font-bold block mb-1">Friendly Name</label>
            <input id="pName" class="w-full bg-gray-950 border border-gray-700 rounded p-2.5 mb-4 text-sm" placeholder="e.g. My Local Ollama">

            <div id="fieldUrlContainer" class="hidden">
                <label class="text-xs text-gray-400 uppercase font-bold block mb-1">Base URL</label>
                <input id="pUrl" class="w-full bg-gray-950 border border-gray-700 rounded p-2.5 mb-4 text-sm" placeholder="http://localhost:11434/v1">
                <p class="text-xs text-yellow-600 mb-4 -mt-2">For Ollama, use: http://localhost:11434/v1</p>
            </div>

            <label class="text-xs text-gray-400 uppercase font-bold block mb-1">Model ID</label>
            <input id="pModel" class="w-full bg-gray-950 border border-gray-700 rounded p-2.5 mb-4 text-sm" placeholder="gpt-4o, claude-3-sonnet, llama3">

            <label class="text-xs text-gray-400 uppercase font-bold block mb-1">API Key</label>
            <input id="pKey" type="password" class="w-full bg-gray-950 border border-gray-700 rounded p-2.5 mb-4 text-sm" placeholder="sk-...">

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="text-xs text-gray-400 uppercase font-bold block mb-1">Input $/1M</label>
                    <input id="pIn" type="number" class="w-full bg-gray-950 border border-gray-700 rounded p-2.5 text-sm" placeholder="0.50">
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase font-bold block mb-1">Output $/1M</label>
                    <input id="pOut" type="number" class="w-full bg-gray-950 border border-gray-700 rounded p-2.5 text-sm" placeholder="1.50">
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeAddModal()" class="flex-1 py-2.5 bg-gray-800 hover:bg-gray-700 rounded-lg font-medium">Cancel</button>
                <button onclick="saveProvider()" class="flex-1 py-2.5 bg-purple-600 hover:bg-purple-700 rounded-lg font-medium">Save</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="modalSettings" class="modal fixed inset-0 z-50 items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-gray-900 w-full max-w-sm rounded-xl border border-gray-800 p-6">
            <h3 class="text-xl font-bold mb-4">Settings</h3>
            <button onclick="clearData()" class="w-full py-3 bg-red-900/30 text-red-400 border border-red-900 hover:bg-red-900/50 rounded-lg mb-3 font-medium">
                ‚ö†Ô∏è Clear All Data
            </button>
            <button onclick="document.getElementById('modalSettings').classList.remove('active')" class="w-full py-3 bg-gray-800 hover:bg-gray-700 rounded-lg font-medium">
                Close
            </button>
        </div>
    </div>

    <script>
        /**
         * AI COST TRACKER v4.0 - Logic Engine
         * Fixes: Markdown support, robust Custom URL handling, improved CORS error messaging.
         */

        // --- STATE MANAGEMENT ---
        let providers = JSON.parse(localStorage.getItem('act_providers') || '[]');
        let usage = JSON.parse(localStorage.getItem('act_usage') || '[]');

        function saveState() {
            localStorage.setItem('act_providers', JSON.stringify(providers));
            localStorage.setItem('act_usage', JSON.stringify(usage));
            renderUI();
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            renderUI();
            // Setup input listener for cost estimation
            document.getElementById('promptInput').addEventListener('input', updateEstimate);
            document.getElementById('activeProvider').addEventListener('change', updateEstimate);
        });

        // --- RENDERING UI ---
        function renderUI() {
            // 1. Stats
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            const todayUsage = usage.filter(u => new Date(u.ts) >= startOfDay);
            const monthUsage = usage.filter(u => new Date(u.ts) >= startOfMonth);

            const sumCost = (arr) => arr.reduce((a, b) => a + (b.cost || 0), 0);
            
            document.getElementById('statToday').innerText = `$${sumCost(todayUsage).toFixed(4)}`;
            document.getElementById('statMonth').innerText = `$${sumCost(monthUsage).toFixed(4)}`;
            document.getElementById('statRequests').innerText = usage.length;
            document.getElementById('statTokens').innerText = usage.reduce((a,b) => a + (b.inTok + b.outTok), 0).toLocaleString();

            // 2. Providers List
            const list = document.getElementById('providerList');
            const empty = document.getElementById('emptyProviders');
            const select = document.getElementById('activeProvider');
            
            list.innerHTML = '';
            const savedVal = select.value; // Preserve selection
            select.innerHTML = '<option value="">Select Provider...</option>';

            if (providers.length === 0) {
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                providers.forEach(p => {
                    // Add to Dashboard List
                    const div = document.createElement('div');
                    div.className = 'bg-gray-900 p-4 rounded-lg border border-gray-800 flex justify-between items-center group hover:border-gray-700 transition';
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="h-8 w-8 rounded-full bg-gradient-to-br from-gray-800 to-black border border-gray-700 flex items-center justify-center text-xs font-bold">
                                ${p.type.substring(0,2).toUpperCase()}
                            </div>
                            <div>
                                <p class="font-semibold text-sm">${p.name}</p>
                                <p class="text-xs text-gray-500">${p.model}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-xs text-gray-500 font-mono">$${p.totalCost?.toFixed(4) || '0.0000'}</span>
                            <button onclick="deleteProvider('${p.id}')" class="text-gray-600 hover:text-red-400">‚úï</button>
                        </div>
                    `;
                    list.appendChild(div);

                    // Add to Dropdown
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.innerText = `${p.name} (${p.model})`;
                    select.appendChild(opt);
                });
                select.value = savedVal;
            }
        }

        // --- CORE LOGIC: ESTIMATION ---
        function updateEstimate() {
            const text = document.getElementById('promptInput').value;
            const pid = document.getElementById('activeProvider').value;
            const display = document.getElementById('estCost');

            if (!text || !pid) {
                display.innerText = '$0.0000 est.';
                return;
            }

            const p = providers.find(x => x.id === pid);
            // Rough rule of thumb: 1 token ~= 4 chars
            const tokens = Math.ceil(text.length / 4);
            const cost = (tokens / 1_000_000) * p.inPrice;
            
            display.innerText = `~${tokens} toks ‚Ä¢ $${cost.toFixed(6)} est.`;
        }

        // --- CORE LOGIC: API CALLS ---
        async function runPrompt() {
            const pid = document.getElementById('activeProvider').value;
            const prompt = document.getElementById('promptInput').value;
            const btn = document.getElementById('sendBtn');
            const outArea = document.getElementById('outputArea');
            const outContent = document.getElementById('outputContent');
            const runStats = document.getElementById('runStats');

            if (!pid) return alert("Please select a provider.");
            if (!prompt) return alert("Please enter a prompt.");

            const provider = providers.find(x => x.id === pid);
            
            // UI Loading State
            btn.innerText = "Thinking...";
            btn.disabled = true;
            outArea.classList.remove('hidden');
            outContent.innerHTML = '<span class="animate-pulse text-gray-500">Waiting for response...</span>';

            try {
                let result;
                
                if (provider.type === 'gemini') {
                    result = await callGemini(provider, prompt);
                } else {
                    // Universal Handler (OpenAI, Anthropic, Custom/Ollama)
                    result = await callUniversal(provider, prompt);
                }

                // Render Markdown
                outContent.innerHTML = marked.parse(result.text);

                // Stats
                const cost = (result.inTok / 1000000 * provider.inPrice) + (result.outTok / 1000000 * provider.outPrice);
                runStats.innerText = `In: ${result.inTok} ‚Ä¢ Out: ${result.outTok} ‚Ä¢ Cost: $${cost.toFixed(6)}`;

                // Save Data
                usage.push({
                    id: Date.now(),
                    pid: provider.id,
                    ts: new Date().toISOString(),
                    inTok: result.inTok,
                    outTok: result.outTok,
                    cost: cost
                });
                
                // Update Provider Total
                provider.totalCost = (provider.totalCost || 0) + cost;
                
                saveState();

            } catch (err) {
                outContent.innerHTML = `<div class="text-red-400 bg-red-900/20 p-3 rounded border border-red-900">
                    <strong>Error:</strong> ${err.message}
                    <br/><br/>
                    <small class="text-gray-400">Tip: If this is a CORS error, use a Local LLM (Ollama) or a provider that allows browser access.</small>
                </div>`;
                console.error(err);
            } finally {
                btn.innerText = "Run Request";
                btn.disabled = false;
            }
        }

        // --- API HANDLERS ---

        async function callUniversal(p, prompt) {
            // Determine Endpoint
            let url = '';
            let headers = { "Content-Type": "application/json" };
            let body = {
                model: p.model,
                messages: [{ role: "user", content: prompt }],
                stream: false 
            };

            if (p.type === 'openai') {
                url = 'https://api.openai.com/v1/chat/completions';
                headers["Authorization"] = `Bearer ${p.apiKey}`;
            } else if (p.type === 'anthropic') {
                // Anthropic requires a proxy usually, but we try direct just in case they change headers
                url = 'https://api.anthropic.com/v1/messages';
                headers["x-api-key"] = p.apiKey;
                headers["anthropic-version"] = "2023-06-01";
                headers["anthropic-dangerous-direct-browser-access"] = "true"; // Required for browser
                body = {
                    model: p.model,
                    max_tokens: 1024,
                    messages: [{ role: "user", content: prompt }]
                };
            } else if (p.type === 'custom') {
                // Custom / Ollama / Groq
                url = p.baseUrl.endsWith('/') ? `${p.baseUrl}chat/completions` : `${p.baseUrl}/chat/completions`;
                // Some local LLMs don't need keys, but if provided, send it
                if (p.apiKey) headers["Authorization"] = `Bearer ${p.apiKey}`;
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`API Error (${response.status}): ${errText}`);
            }

            const json = await response.json();
            
            // Parsing Logic
            let text = "";
            let inTok = 0;
            let outTok = 0;

            if (p.type === 'anthropic') {
                text = json.content[0].text;
                inTok = json.usage.input_tokens;
                outTok = json.usage.output_tokens;
            } else {
                // OpenAI / Compatible Standard
                text = json.choices[0].message.content;
                inTok = json.usage?.prompt_tokens || prompt.length / 4;
                outTok = json.usage?.completion_tokens || text.length / 4;
            }

            return { text, inTok, outTok };
        }

        async function callGemini(p, prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${p.model}:generateContent?key=${p.apiKey}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            if (!response.ok) throw new Error(await response.text());
            const json = await response.json();
            
            const text = json.candidates[0].content.parts[0].text;
            // Gemini doesn't always return usage in v1beta without extra fields, estimating:
            return { 
                text, 
                inTok: Math.ceil(prompt.length/4), 
                outTok: Math.ceil(text.length/4) 
            };
        }

        // --- MODAL ACTIONS ---
        function openAddModal() { document.getElementById('modalAdd').classList.add('active'); }
        function closeAddModal() { document.getElementById('modalAdd').classList.remove('active'); }
        function openSettings() { document.getElementById('modalSettings').classList.add('active'); }

        function toggleFields() {
            const type = document.getElementById('pType').value;
            const urlContainer = document.getElementById('fieldUrlContainer');
            if (type === 'custom') {
                urlContainer.classList.remove('hidden');
                document.getElementById('pModel').placeholder = "llama3, mistral, etc.";
            } else {
                urlContainer.classList.add('hidden');
            }
        }

        function saveProvider() {
            const type = document.getElementById('pType').value;
            const name = document.getElementById('pName').value || type;
            const model = document.getElementById('pModel').value;
            const key = document.getElementById('pKey').value;
            const baseUrl = document.getElementById('pUrl').value;
            const inPrice = parseFloat(document.getElementById('pIn').value) || 0;
            const outPrice = parseFloat(document.getElementById('pOut').value) || 0;

            if (!model) return alert("Model ID is required");
            if (type !== 'custom' && !key) return alert("API Key is required");
            if (type === 'custom' && !baseUrl) return alert("Base URL required for custom providers");

            providers.push({
                id: Date.now().toString(),
                type, name, model, apiKey: key, baseUrl, inPrice, outPrice, totalCost: 0
            });
            
            saveState();
            closeAddModal();
            
            // Clear inputs
            document.getElementById('pKey').value = '';
            document.getElementById('pName').value = '';
        }

        function deleteProvider(id) {
            if(confirm('Remove this provider?')) {
                providers = providers.filter(p => p.id !== id);
                saveState();
            }
        }

        function clearData() {
            if(confirm('Delete ALL data? This cannot be undone.')) {
                providers = [];
                usage = [];
                saveState();
                document.getElementById('modalSettings').classList.remove('active');
            }
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({providers, usage}));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", "ai_cost_tracker_backup.json");
            dlAnchorElem.click();
        }

    </script>
</body>
</html>
