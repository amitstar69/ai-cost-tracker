<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Cost Tracker v6.2 (Frontier Models & UX)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XXXXXXXXXX');
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; }
        .modal.active { display: flex; }
        
        /* Markdown Styles */
        .prose pre { background: #1f2937; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin-top: 0.5rem; }
        .prose code { color: #e9d5ff; font-family: monospace; font-size: 0.9em; }
        .prose p { margin-bottom: 0.75rem; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        .prose strong { color: #fff; font-weight: 600; }

        /* Spinner for streaming */
        .stream-cursor { 
            display: inline-block; 
            width: 0.5em; 
            height: 1.2em; 
            background-color: #fff; 
            animation: blink 0.7s infinite; 
            margin-left: 2px;
            vertical-align: middle;
        }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen pb-20">

    <header class="border-b border-gray-800 bg-gray-900/50 backdrop-blur-md sticky top-0 z-30">
        <div class="max-w-5xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="text-2xl">üìâ</div>
                <div>
                    <h1 class="text-xl font-bold">AI Cost Tracker <span class="text-xs bg-green-900 text-green-200 px-2 py-0.5 rounded">v6.2</span></h1>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="exportData()" class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 rounded text-sm border border-gray-700">Export</button>
                <button onclick="openSettings()" class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 rounded text-sm border border-gray-700">‚öôÔ∏è</button>
                <button onclick="openAboutModal()" class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 rounded text-sm border border-gray-700">?</button>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-8">
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-gray-900 p-5 rounded-xl border border-gray-800">
                <p class="text-gray-400 text-xs uppercase font-semibold">Today</p>
                <h3 id="statToday" class="text-2xl font-bold text-white mt-1">$0.00</h3>
            </div>
            <div class="bg-gray-900 p-5 rounded-xl border border-gray-800">
                <p class="text-gray-400 text-xs uppercase font-semibold">This Month</p>
                <h3 id="statMonth" class="text-2xl font-bold text-white mt-1">$0.00</h3>
            </div>
            <div class="bg-gray-900 p-5 rounded-xl border border-gray-800">
                <p class="text-gray-400 text-xs uppercase font-semibold">Requests</p>
                <h3 id="statRequests" class="text-2xl font-bold text-blue-400 mt-1">0</h3>
            </div>
            <div class="bg-gray-900 p-5 rounded-xl border border-gray-800">
                <p class="text-gray-400 text-xs uppercase font-semibold">Est. Tokens</p>
                <h3 id="statTokens" class="text-2xl font-bold text-purple-400 mt-1">0</h3>
            </div>
        </div>

        <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">Connected APIs</h2>
                <button onclick="openAddModal()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm font-medium flex items-center gap-2 shadow-lg shadow-purple-900/20 transition-all hover:scale-105">
                    <span>+</span> Connect API
                </button>
            </div>
            
            <div id="providerList" class="grid gap-3"></div>
            
            <div id="emptyProviders" class="hidden text-center py-12 border-2 border-dashed border-gray-800 rounded-xl bg-gray-900/30">
                <p class="text-gray-500 font-medium">No APIs connected yet.</p>
                <p class="text-gray-600 text-sm mt-1">Connect OpenRouter, Gemini, or Ollama to start.</p>
            </div>
        </div>

        <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-hidden shadow-2xl">
            <div class="p-4 border-b border-gray-800 bg-gray-800/50 flex justify-between items-center">
                <h2 class="font-semibold text-gray-200">Playground</h2>
                <div class="flex items-center gap-3">
                    <span id="estCost" class="text-xs text-gray-500 font-mono transition-colors">$0.0000 est.</span>
                    <select id="activeProvider" class="bg-gray-950 border border-gray-700 rounded px-2 py-1.5 text-sm max-w-[200px] text-gray-300 focus:border-purple-500 outline-none">
                        <option value="">Select Provider...</option>
                    </select>
                </div>
            </div>
            
            <div class="p-4">
                <textarea id="promptInput" class="w-full bg-gray-950 text-gray-200 p-4 rounded-lg border border-gray-800 focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none resize-none h-40 font-mono text-sm transition-all" placeholder="Type your prompt here... (Cmd/Ctrl+Enter to send)"></textarea>
                
                <div class="flex justify-end mt-3">
                    <button id="sendBtn" onclick="runPrompt()" class="px-6 py-2.5 bg-white text-black hover:bg-gray-200 font-bold rounded-lg transition flex items-center gap-2 shadow-lg shadow-white/10">
                        Run Request
                    </button>
                </div>
            </div>

            <div id="outputArea" class="hidden border-t border-gray-800 bg-black/20 p-6">
                <div class="flex justify-between text-xs text-gray-500 mb-4 font-mono border-b border-gray-800 pb-2">
                    <span>RESULT</span>
                    <span id="runStats">0 tokens ‚Ä¢ $0.0000</span>
                </div>
                <div id="outputContent" class="prose prose-invert max-w-none text-sm text-gray-300 leading-relaxed min-h-8"></div>
            </div>
        </div>

        <div class="mt-8 bg-gray-900 rounded-xl border border-gray-800 overflow-hidden shadow-2xl">
            <div class="p-4 border-b border-gray-800 bg-gray-800/50 flex justify-between items-center">
                <h2 class="font-semibold text-gray-200">Recent Activity (Last 10)</h2>
            </div>
            <div id="historyLog" class="p-4 space-y-3">
                <p class="text-gray-500 text-center text-sm italic">No recent usage found.</p>
            </div>
        </div>

    </main>

    <div id="modalAdd" class="modal fixed inset-0 z-50 items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-gray-900 w-full max-w-md rounded-xl border border-gray-800 shadow-2xl p-6 transition-all">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Connect API</h3>
                <button onclick="closeAddModal()" class="text-gray-500 hover:text-white text-xl">&times;</button>
            </div>
            
            <label class="text-xs text-gray-400 uppercase font-bold block mb-1.5">Provider</label>
            <select id="pType" onchange="updateModalUI()" class="w-full bg-gray-950 border border-gray-700 rounded-lg p-3 mb-4 text-sm focus:border-purple-500 outline-none text-white">
                <option value="openai">OpenAI (GPT)</option>
                <option value="gemini">Google Gemini</option>
                <option value="anthropic">Anthropic (Claude)</option> <option value="grok">xAI (Grok)</option> <option value="kimi">Moonshot AI (Kimi)</option> <option value="openrouter">OpenRouter (Recommended)</option>
                <option value="ollama">Ollama (Local)</option>
                <option value="custom">Custom / Other</option>
            </select>

            <div id="smartModelContainer">
                <label class="text-xs text-gray-400 uppercase font-bold block mb-1.5">Model</label>
                <select id="pPreset" class="w-full bg-gray-950 border border-gray-700 rounded-lg p-3 mb-4 text-sm focus:border-purple-500 outline-none text-white"></select>
                <p class="text-xs text-gray-500 mb-4 -mt-2">Prices are auto-calculated for the selected model.</p>
            </div>

            <div id="customFields" class="hidden">
                <label class="text-xs text-gray-400 uppercase font-bold block mb-1.5">Model ID</label>
                <input id="pModelRaw" class="w-full bg-gray-950 border border-gray-700 rounded-lg p-3 mb-3 text-sm" placeholder="e.g. llama-3-70b">
                
                <label class="text-xs text-gray-400 uppercase font-bold block mb-1.5">Base URL</label>
                <input id="pUrl" class="w-full bg-gray-950 border border-gray-700 rounded-lg p-3 mb-4 text-sm" placeholder="https://api.example.com/v1">

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase font-bold">Input $/1M</label>
                        <input id="pIn" type="number" class="w-full bg-gray-950 border border-gray-700 rounded p-2 text-sm" placeholder="0.50">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase font-bold">Output $/1M</label>
                        <input id="pOut" type="number" class="w-full bg-gray-950 border border-gray-700 rounded p-2 text-sm" placeholder="1.50">
                    </div>
                </div>
            </div>

            <div id="apiKeyContainer">
                <label id="pKeyLabel" class="text-xs text-gray-400 uppercase font-bold block mb-1.5">API Key</label>
                <input id="pKey" type="password" class="w-full bg-gray-950 border border-gray-700 rounded-lg p-3 mb-4 text-sm focus:border-purple-500 outline-none" placeholder="sk-...">
            </div>
            
            <div id="healthCheckStatus" class="hidden text-xs text-red-400 bg-red-900/20 p-3 rounded-lg border border-red-900 mb-4 transition-all"></div>

            <button id="modalConnectBtn" onclick="saveProvider()" class="w-full py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold text-white transition shadow-lg shadow-purple-900/20">
                Connect
            </button>
        </div>
    </div>

    <div id="modalSettings" class="modal fixed inset-0 z-50 items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-gray-900 w-full max-w-sm rounded-xl border border-gray-800 p-6">
            <h3 class="text-xl font-bold mb-4">Settings</h3>
            
            <button onclick="clearUsageOnly()" class="w-full py-3 bg-blue-900/20 text-blue-400 border border-blue-900/50 hover:bg-blue-900/40 rounded-lg mb-3 font-medium transition">
                Clear Usage History Only
            </button>

            <button onclick="clearData()" class="w-full py-3 bg-red-900/20 text-red-400 border border-red-900/50 hover:bg-red-900/40 rounded-lg mb-3 font-medium transition">
                ‚ö†Ô∏è Clear ALL Data (Keys & History)
            </button>
            <button onclick="closeSettings()" class="w-full py-3 bg-gray-800 hover:bg-gray-700 rounded-lg font-medium">
                Close
            </button>
        </div>
    </div>

    <div id="modalAbout" class="modal fixed inset-0 z-50 items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-gray-900 w-full max-w-xl rounded-xl border border-gray-800 shadow-2xl p-6 transition-all">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">About AI Cost Tracker</h3>
                <button onclick="closeAboutModal()" class="text-gray-500 hover:text-white text-xl">&times;</button>
            </div>
            <div class="prose prose-invert text-sm text-gray-300 leading-relaxed">
                <p>The **AI Cost Tracker** is a minimal, client-side tool designed to give you **transparent, real-time control** over your AI service spending. It lets you consolidate usage from various commercial and self-hosted models into a single, unified view.</p>
                
                <h4>üõ°Ô∏è Privacy and Data Security</h4>
                <p>The core principle of the AI Cost Tracker is **complete data sovereignty**.</p>
                <ul>
                    <li>**No Cloud Storage:** We do not use any database, server, or cloud service to store your usage data or API keys.</li>
                    <li>**Local Storage Only:** All your configuration (API keys, models, usage history, and settings) is stored exclusively in your browser's **Local Storage** and never leaves your device.</li>
                    <li>**Direct API Calls:** When you run a prompt, your browser communicates **directly** with the selected AI provider (e.g., OpenAI or Gemini). The data is **never proxied** through or recorded by this application.</li>
                </ul>
            </div>
        </div>
    </div>


    <script>
        // V6.2 - EXPANDED MODEL PRESETS & DYNAMIC URLS
        const PRESETS = {
            'openai': [
                { id: 'gpt-4o', name: 'GPT-4o', in: 5.00, out: 15.00, emoji: 'üß†' },
                { id: 'gpt-4o-mini', name: 'GPT-4o Mini', in: 0.15, out: 0.60, emoji: '‚öôÔ∏è' },
                { id: 'gpt-4-turbo-2024-04-09', name: 'GPT-4 Turbo', in: 10.00, out: 30.00, emoji: 'üöÄ' },
                { id: 'gpt-3.5-turbo-0125', name: 'GPT-3.5 Turbo', in: 0.50, out: 1.50, emoji: 'üí®' }
            ],
            'gemini': [
                { id: 'gemini-2.5-flash', name: 'Gemini 2.5 Flash', in: 0.35, out: 0.45, emoji: '‚ö°' },
                { id: 'gemini-2.5-pro', name: 'Gemini 2.5 Pro', in: 3.50, out: 10.50, emoji: '‚ú®' },
                { id: 'gemini-2.5-flash-lite', name: 'Gemini 2.5 Flash-Lite', in: 0.15, out: 0.25, emoji: 'üìâ' }
            ],
            'anthropic': [ // V6.2 ADDITION
                { id: 'claude-4-1-opus', name: 'Claude 4.1 Opus', in: 15.00, out: 75.00, emoji: 'üåü' },
                { id: 'claude-4-1-sonnet', name: 'Claude 4.1 Sonnet', in: 5.00, out: 25.00, emoji: '‚ú®' },
                { id: 'claude-3-5-haiku', name: 'Claude 3.5 Haiku', in: 0.80, out: 4.00, emoji: 'üçÉ' }
            ],
            'grok': [ // V6.2 ADDITION
                { id: 'grok-4', name: 'Grok-4 (Frontier)', in: 3.00, out: 15.00, emoji: 'üöÄ' },
                { id: 'grok-4-fast-reasoning', name: 'Grok-4 Fast', in: 0.20, out: 0.50, emoji: '‚ö°' }
            ],
            'kimi': [ // V6.2 ADDITION
                { id: 'kimi-k2-0905-preview', name: 'Kimi K2 Instruct', in: 0.60, out: 2.50, emoji: 'üî•' },
                { id: 'kimi-k2-thinking', name: 'Kimi K2 Thinking', in: 0.60, out: 2.50, emoji: 'üí≠' }
            ],
            'openrouter': [
                { id: 'anthropic/claude-3.5-sonnet', name: 'Claude 3.5 Sonnet', in: 3.00, out: 15.00, emoji: 'üî•' },
                { id: 'openai/gpt-4o', name: 'GPT-4o', in: 5.00, out: 15.00, emoji: 'üß†' },
                { id: 'meta-llama/llama-3.1-70b-instruct', name: 'Llama 3.1 70B', in: 0.4, out: 0.4, emoji: 'ü¶ô' }
            ],
            'ollama': [
                { id: 'llama3', name: 'Llama 3 (Local)', in: 0, out: 0, emoji: 'üè†' },
                { id: 'mistral', name: 'Mistral (Local)', in: 0, out: 0, emoji: 'üè†' }
            ]
        };

        let providers = JSON.parse(localStorage.getItem('act_providers') || '[]');
        let usage = JSON.parse(localStorage.getItem('act_usage') || '[]');
        const decoder = new TextDecoder("utf-8");
        const TOKEN_EST_FACTOR = 4; // Approx chars per token

        /* ---------------- V6.1 ANALYTICS FUNCTION ---------------- */

        function trackAnalytics(p, inTok, outTok, cost, isSuccess, latencyMs, errorCode) {
            if (typeof gtag !== 'function') return;

            gtag('event', 'ai_request_completed', {
                provider_name: p.name,
                model_id: p.model,
                is_success: isSuccess,
                input_tokens: inTok,
                output_tokens: outTok,
                cost_usd: cost,
                latency_ms: latencyMs,
                error_code: errorCode || 'N/A',
                currency: 'USD',
                value: cost 
            });
        }
        
        /* ---------------- INITIALIZATION & STATE ---------------- */
        document.addEventListener('DOMContentLoaded', () => {
            renderUI();
            updateModalUI(); 
            
            document.getElementById('promptInput').addEventListener('input', updateEstimate);
            document.getElementById('activeProvider').addEventListener('change', updateEstimate);

            document.getElementById('promptInput').addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                    e.preventDefault();
                    runPrompt();
                }
            });
        });

        function saveState() {
            localStorage.setItem('act_providers', JSON.stringify(providers));
            localStorage.setItem('act_usage', JSON.stringify(usage));
            renderUI();
        }

        /* ---------------- UI RENDERING ---------------- */
        
        function renderUI() {
            // Calculate Stats
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            const todayCost = usage.filter(u => new Date(u.ts) >= todayStart).reduce((a,b) => a + b.cost, 0);
            const monthCost = usage.filter(u => new Date(u.ts) >= startOfMonth).reduce((a,b) => a + b.cost, 0);
            
            document.getElementById('statToday').innerText = `$${todayCost.toFixed(4)}`;
            document.getElementById('statMonth').innerText = `$${monthCost.toFixed(4)}`;
            document.getElementById('statRequests').innerText = usage.length.toLocaleString();
            document.getElementById('statTokens').innerText = usage.reduce((a,b) => a + b.inTok + b.outTok, 0).toLocaleString();

            // Render Providers & Dropdown
            const list = document.getElementById('providerList');
            const empty = document.getElementById('emptyProviders');
            const select = document.getElementById('activeProvider');
            
            list.innerHTML = '';
            const savedVal = select.value;
            select.innerHTML = '<option value="">Select Provider...</option>';

            if (providers.length === 0) {
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                providers.forEach(p => {
                    // List Item
                    const div = document.createElement('div');
                    div.className = 'bg-gray-900 p-4 rounded-lg border border-gray-800 flex justify-between items-center group hover:border-gray-700 transition';
                    const totalCost = usage.filter(u => u.pid === p.id).reduce((a,b) => a + b.cost, 0);
                    p.totalCost = totalCost;
                    
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 rounded-full bg-gradient-to-br from-gray-800 to-black border border-gray-700 flex items-center justify-center font-bold text-gray-400">
                                ${p.type.substring(0,2).toUpperCase()}
                            </div>
                            <div>
                                <p class="font-bold text-sm text-gray-200">${p.name}</p>
                                <p class="text-xs text-gray-500 font-mono">${p.model}</p>
                            </div>
                        </div>
                        <div class="text-right">
                             <p class="text-xs text-gray-400 font-mono mb-1">$${totalCost.toFixed(4)}</p>
                             <button onclick="deleteProvider('${p.id}')" class="text-xs text-red-900 hover:text-red-400 transition">Remove</button>
                        </div>
                    `;
                    list.appendChild(div);
                    
                    // Dropdown Item
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.innerText = `${p.name}`;
                    select.appendChild(opt);
                });
                select.value = savedVal;
            }

            // Render History Log (V6.0 Feature)
            renderHistoryLog();
        }

        function renderHistoryLog() {
            const logDiv = document.getElementById('historyLog');
            const recentUsage = usage.slice().sort((a,b) => b.id - a.id).slice(0, 10);
            
            if (recentUsage.length === 0) {
                logDiv.innerHTML = '<p class="text-gray-500 text-center text-sm italic">No recent usage found.</p>';
                return;
            }

            logDiv.innerHTML = recentUsage.map(u => {
                const p = providers.find(x => x.id === u.pid);
                const pName = p ? p.name.split('(')[0].trim() : 'Deleted Provider';
                const date = new Date(u.ts).toLocaleTimeString();

                return `
                    <div class="flex justify-between items-center text-xs font-mono bg-gray-950 p-3 rounded-lg border border-gray-800">
                        <div class="flex flex-col">
                            <span class="text-gray-300 font-semibold">${pName}</span>
                            <span class="text-gray-500">${p ? p.model : 'N/A'}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-green-400 font-bold">$${u.cost.toFixed(6)}</span>
                            <span class="text-gray-500 ml-2">(${u.inTok + u.outTok} toks)</span>
                            <span class="text-gray-600 ml-2">${date}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateEstimate() {
            const pid = document.getElementById('activeProvider').value;
            const prompt = document.getElementById('promptInput').value;
            const estCostSpan = document.getElementById('estCost');

            if (!pid || !prompt) {
                estCostSpan.innerText = '$0.0000 est.';
                return;
            }

            const p = providers.find(x => x.id === pid);
            if (!p) return;

            // Simple char count for estimation
            const inTokEst = Math.ceil(prompt.length / TOKEN_EST_FACTOR);
            const estCost = (inTokEst / 1e6 * p.inPrice); 
            estCostSpan.innerText = `$${estCost.toFixed(6)} est.`;
        }


        /* ---------------- MODAL & LIFECYCLE ---------------- */

        function updateModalUI() {
            const type = document.getElementById('pType').value;
            const smartContainer = document.getElementById('smartModelContainer');
            const customContainer = document.getElementById('customFields');
            const keyContainer = document.getElementById('apiKeyContainer');
            const presetSelect = document.getElementById('pPreset');
            const pKeyInput = document.getElementById('pKey');
            const pKeyLabel = document.getElementById('pKeyLabel');
            const pUrlInput = document.getElementById('pUrl');
            
            const isCustom = type === 'custom';
            const isOllama = type === 'ollama';

            smartContainer.classList.toggle('hidden', isCustom);
            customContainer.classList.toggle('hidden', !isCustom);
            keyContainer.classList.toggle('hidden', isOllama && !isCustom);
            
            let defaultUrl = '';
            let keyPlaceholder = 'sk- (required)';

            // V6.2: Set URL and Key placeholder based on type
            if (type === 'openai') {
                defaultUrl = 'https://api.openai.com/v1';
                keyPlaceholder = 'OpenAI Key (e.g., sk-...)';
            } else if (type === 'gemini') {
                defaultUrl = 'https://generativelanguage.googleapis.com/v1beta/models';
                keyPlaceholder = 'Gemini Key (e.g., AIza...)';
            } else if (type === 'anthropic') { // V6.2
                defaultUrl = 'https://api.anthropic.com/v1';
                keyPlaceholder = 'Anthropic Key (e.g., sk-ant-...)';
            } else if (type === 'grok') { // V6.2
                defaultUrl = 'https://api.x.ai/v1';
                keyPlaceholder = 'Grok Key (e.g., grok-...)';
            } else if (type === 'kimi') { // V6.2
                defaultUrl = 'https://api.moonshot.ai/v1';
                keyPlaceholder = 'Kimi Key (e.g., sk-moon-...)';
            } else if (type === 'openrouter') {
                defaultUrl = 'https://openrouter.ai/api/v1';
                keyPlaceholder = 'OpenRouter Key (e.g., sk-or-...)';
            } else if (type === 'ollama') {
                defaultUrl = 'http://localhost:11434/v1';
                keyPlaceholder = 'Not Required (Local)';
            }

            pKeyInput.placeholder = keyPlaceholder;
            pKeyLabel.innerText = `${type.toUpperCase()} API KEY`;
            pUrlInput.value = defaultUrl;


            if (!isCustom) {
                presetSelect.innerHTML = '';
                const list = PRESETS[type] || [];
                list.forEach(m => {
                    const opt = document.createElement('option');
                    // Store the price details in the value for easy retrieval
                    opt.value = JSON.stringify({ name: m.name, model: m.id, inPrice: m.in, outPrice: m.out }); 
                    opt.innerText = `${m.emoji || ''} ${m.name} ($${m.in} / $${m.out} per 1M)`;
                    presetSelect.appendChild(opt);
                });
            }
        }

        async function saveProvider() {
            const type = document.getElementById('pType').value;
            let name, modelId, inPrice, outPrice, baseUrl, apiKey;
            const btn = document.getElementById('modalConnectBtn');
            const statusDiv = document.getElementById('healthCheckStatus');

            statusDiv.classList.add('hidden');
            btn.disabled = true;
            btn.innerText = "Testing Connection...";

            // 1. Prepare Provider Object
            if (type === 'custom') {
                modelId = document.getElementById('pModelRaw').value;
                baseUrl = document.getElementById('pUrl').value;
                inPrice = parseFloat(document.getElementById('pIn').value) || 0;
                outPrice = parseFloat(document.getElementById('pOut').value) || 0;
                name = "Custom (" + modelId + ")";
                apiKey = document.getElementById('pKey').value;
                if (!baseUrl) {
                    statusDiv.innerText = "Error: Base URL required for Custom.";
                    statusDiv.classList.remove('hidden');
                    btn.disabled = false;
                    btn.innerText = "Retry Connect";
                    return;
                }
            } else {
                const presetValues = JSON.parse(document.getElementById('pPreset').value);
                modelId = presetValues.model;
                name = presetValues.name;
                inPrice = presetValues.inPrice;
                outPrice = presetValues.outPrice;
                baseUrl = document.getElementById('pUrl').value; // Get the auto-populated URL
                apiKey = document.getElementById('pKey').value;
            }

            if (type !== 'ollama' && !apiKey) {
                statusDiv.innerText = "Error: API Key required.";
                statusDiv.classList.remove('hidden');
                btn.disabled = false;
                btn.innerText = "Retry Connect";
                return;
            }
            
            const newProvider = { id: Date.now().toString(), type, name, model: modelId, apiKey, baseUrl, inPrice, outPrice, totalCost: 0 };
            
            // 2. Run Health Check (V6.0 Feature)
            const healthCheck = await pingProvider(newProvider);

            if (healthCheck === true) {
                providers.push(newProvider);
                saveState();
                
                statusDiv.innerText = `Success! ${newProvider.name} connected.`;
                statusDiv.classList.remove('hidden');
                statusDiv.classList.replace('text-red-400', 'text-green-400');
                statusDiv.classList.replace('bg-red-900/20', 'bg-green-900/20');

                setTimeout(() => {
                    closeAddModal();
                    document.getElementById('pKey').value = '';
                    statusDiv.classList.add('hidden');
                }, 1000);
            } else {
                // Failure: display actionable error
                statusDiv.innerText = healthCheck;
                statusDiv.classList.remove('hidden');
                statusDiv.classList.replace('text-green-400', 'text-red-400');
                statusDiv.classList.replace('bg-green-900/20', 'bg-red-900/20');
                btn.disabled = false;
                btn.innerText = "Retry Connect";
            }
        }

        function clearUsageOnly() {
            if(confirm('Delete all usage history? This will not delete your API keys.')) { 
                usage = []; 
                saveState(); 
                closeSettings();
            }
        }

        /* ---------------- API CALLS & STREAMING ---------------- */

        async function pingProvider(p) {
            try {
                if (p.type === 'gemini') {
                    await callGemini(p, 'ping', true); 
                } else {
                    // Kimi, Anthropic, Grok, OpenAI, OpenRouter, Ollama, Custom all use standard
                    await callStandard(p, 'ping', true);
                }
                return true;
            } catch (e) {
                return parseApiError(e.message, p.type);
            }
        }

        function parseApiError(errorText, type) {
            const statusMatch = errorText.match(/Status: (\d+)/);
            const status = statusMatch ? parseInt(statusMatch[1]) : null;
            
            if (status === 401 || status === 403 || errorText.includes('401') || errorText.includes('403')) {
                return `**Connection Failed (401/403)**: Invalid API Key or Permissions.\n\n**Action:** Check your API key. Generate a new key if necessary.`;
            }
            if (status === 404 || errorText.includes('404')) {
                return `**Connection Failed (404)**: Invalid Model ID or Base URL.\n\n**Action:** Verify the Base URL (e.g., must end in /v1) and the Model ID are correct.`;
            }
            if (type === 'ollama' && errorText.includes('Failed to fetch')) {
                 return `**Connection Failed (Network)**: Could not reach Ollama server.\n\n**Action:** Ensure Ollama is running locally and that you launched it with \`OLLAMA_ORIGINS='*' \`.`;
            }
            if (errorText.includes('Failed to fetch') || errorText.includes('Timeout')) {
                return `**Connection Failed (Network)**: Request timed out or was blocked by CORS.\n\n**Action:** Check your network/browser security settings, or try using OpenRouter.`;
            }

            return `**Connection Failed (Unknown)**: ${errorText.substring(0, 100)}...\n\n**Action:** Check the provider's status page or review your setup.`;
        }


        async function runPrompt() {
            const pid = document.getElementById('activeProvider').value;
            const prompt = document.getElementById('promptInput').value;
            if (!pid || !prompt) return alert("Select provider and enter prompt.");

            const p = providers.find(x => x.id === pid);
            const btn = document.getElementById('sendBtn');
            const outArea = document.getElementById('outputArea');
            const outContent = document.getElementById('outputContent');
            const runStats = document.getElementById('runStats');
            const startTime = performance.now();

            btn.innerHTML = "Thinking... ‚ö°Ô∏è";¬†
            btn.disabled = true;
            outArea.classList.remove('hidden');
            outContent.innerHTML = '<span class="animate-pulse text-gray-500">Connecting...</span>';
            runStats.innerText = 'Calculating...';
            
            outArea.scrollIntoView({ behavior: 'smooth', block: 'start' });

            let fullText = "";
            let inTok = 0;
            let outTok = 0;
            let cost = 0;

            try {
                if (p.type === 'gemini') {
                    // Gemini does not stream via standard API
                    const result = await callGemini(p, prompt, false);
                    fullText = result.text;
                    inTok = result.inTok;
                    outTok = result.outTok;

                    // Manual streaming simulation for UX
                    outContent.innerHTML = '';
                    await streamTextToUI(fullText, outContent);

                } else {
                    // Standard APIs (V6.0 Streaming)
                    // This covers OpenAI, OpenRouter, Ollama, Kimi, Anthropic, Grok, Custom
                    const streamResult = await callStandard(p, prompt, false);
                    
                    outContent.innerHTML = '';
                    const { text, usageMetrics } = await streamStandardResponse(streamResult, outContent);
                    fullText = text;
                    inTok = usageMetrics?.prompt_tokens || Math.ceil(prompt.length / TOKEN_EST_FACTOR);
                    outTok = usageMetrics?.completion_tokens || Math.ceil(fullText.length / TOKEN_EST_FACTOR);
                }

                // Final Cost Calculation
                cost = (inTok / 1e6 * p.inPrice) + (outTok / 1e6 * p.outPrice);
                
                runStats.innerText = `In: ${inTok} ‚Ä¢ Out: ${outTok} ‚Ä¢ Cost: $${cost.toFixed(6)}`;

                // V6.1 ANALYTICS SUCCESS TRACKING
                const latency = performance.now() - startTime;
                trackAnalytics(p, inTok, outTok, cost, true, latency); 
                
                // Update Storage
                usage.push({¬†
                    id: Date.now(), pid: p.id, ts: new Date().toISOString(),¬†
                    inTok, outTok, cost¬†
                });
                saveState();

            } catch (e) {
                outContent.innerHTML = `<div class="bg-red-900/20 border border-red-800 text-red-300 p-4 rounded-lg text-sm">${parseApiError(e.message, p.type)}</div>`;
                runStats.innerText = 'Error';
                
                // V6.1 ANALYTICS FAILURE TRACKING
                const latency = performance.now() - startTime;
                const errorMessage = parseApiError(e.message, p.type);
                trackAnalytics(p, 0, 0, 0, false, latency, errorMessage.substring(0, 50));

            } finally {
                btn.innerHTML = "Run Request";
                btn.disabled = false;
                // Force markdown rendering for the final content
                if (fullText) {
                    outContent.innerHTML = marked.parse(fullText);
                }
            }
        }
        
        async function callStandard(p, prompt, isPing) {
            const body = {
                model: p.model,
                messages: [{ role: "user", content: prompt }],
                stream: !isPing,
                max_tokens: isPing ? 1 : null // Max 1 token for ping
            };

            const headers = {
                'Content-Type': 'application/json',
                // OpenAI-compatible APIs use the Authorization header
                'Authorization': `Bearer ${p.apiKey}`
            };

            // Custom Headers for specific providers using the OpenAI-compatible format
            if (p.type === 'anthropic') {
                headers['x-api-key'] = p.apiKey;
                headers['anthropic-version'] = '2023-06-01';
                delete headers['Authorization']; // Use their specific header
                body.system = "You are a helpful assistant."; // Anthropic requires a system message
            }
            if (p.type === 'grok') {
                // Grok uses the standard bearer token
            }
            if (p.type === 'openrouter') {
                headers['HTTP-Referer'] = 'https://amitstar69.github.io/ai-cost-tracker/'; // Recommended for OpenRouter
                headers['X-Title'] = 'AI Cost Tracker';
            }
            if (p.type === 'ollama') {
                // Ollama API is different, but we use the /v1 path for standard compatibility
                delete body.stream;
            }

            const url = p.baseUrl.replace(/\/v1$/, '') + '/v1/chat/completions';
            
            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(body),
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API Request Failed. Status: ${response.status}. ${errorText}`);
            }

            if (isPing) {
                // For ping, just check for success
                return true; 
            }

            return response;
        }

        async function streamStandardResponse(response, outContent) {
            const reader = response.body.getReader();
            let fullText = '';
            let usageMetrics = null;
            
            const cursor = document.createElement('span');
            cursor.className = 'stream-cursor';
            outContent.appendChild(cursor);

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                
                for (const line of chunk.split('\n')) {
                    if (line.startsWith('data: ')) {
                        const data = line.substring(6).trim();
                        if (data === '[DONE]') {
                            break;
                        }

                        try {
                            const json = JSON.parse(data);
                            const delta = json.choices?.[0]?.delta?.content || "";
                            
                            // Check for final usage metrics (for OpenRouter, Grok, etc.)
                            if (json.usage) {
                                usageMetrics = json.usage;
                            }
                            
                            if (delta) {
                                fullText += delta;
                                // Simple update to the UI for streaming effect
                                outContent.innerHTML = marked.parse(fullText);
                                outContent.appendChild(cursor); // Re-append cursor
                                
                                // Scroll to bottom on new chunk
                                outContent.parentElement.scrollTop = outContent.parentElement.scrollHeight; 
                            }
                        } catch (e) {
                            // Ignore parsing errors for non-JSON lines
                        }
                    }
                }
            }
            cursor.remove(); // Remove cursor when done
            return { text: fullText, usageMetrics };
        }

        async function callGemini(p, prompt, isPing) {
            // Note: Gemini uses a slightly different non-streaming API
            const body = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
            };

            const url = `${p.baseUrl}/${p.model}:generateContent?key=${p.apiKey}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Gemini Request Failed. Status: ${response.status}. ${errorText}`);
            }

            const json = await response.json();
            
            if (isPing) {
                return true;
            }

            const text = json.candidates?.[0]?.content?.parts?.[0]?.text || '';
            const inTok = json.usageMetadata?.promptTokenCount || 0;
            const outTok = json.usageMetadata?.candidatesTokenCount || 0;
            
            return { text, inTok, outTok };
        }
        
        // --- MODAL CONTROLS ---
        function openAddModal() {
            document.getElementById('modalAdd').classList.add('active');
            updateModalUI();
        }
        function closeAddModal() {
            document.getElementById('modalAdd').classList.remove('active');
        }
        function openSettings() {
            document.getElementById('modalSettings').classList.add('active');
        }
        function closeSettings() {
            document.getElementById('modalSettings').classList.remove('active');
        }
        function openAboutModal() {
            document.getElementById('modalAbout').classList.add('active');
        }
        function closeAboutModal() {
            document.getElementById('modalAbout').classList.remove('active');
        }
        function deleteProvider(id) {
            if (confirm('Are you sure you want to delete this provider? This will NOT delete its usage history.')) {
                providers = providers.filter(p => p.id !== id);
                saveState();
                const select = document.getElementById('activeProvider');
                if (select.value === id) {
                    select.value = '';
                }
            }
        }
        function clearData() {
            if(confirm('WARNING: This will delete ALL API keys, models, and usage history from your browser.')) {
                localStorage.removeItem('act_providers');
                localStorage.removeItem('act_usage');
                providers = [];
                usage = [];
                saveState();
                closeSettings();
            }
        }
        function exportData() {
            const data = {
                providers: providers,
                usage: usage
            };
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ai-cost-tracker-export.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

    </script>
</body>
</html>
