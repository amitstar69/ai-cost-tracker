push(usage);
                setData('ai-cost-tracker-usage', usageData);

                document.getElementById('responseText').textContent = result.response;
                document.getElementById('responseTime').textContent = `${duration}s`;
                document.getElementById('inputTokens').textContent = result.promptTokens.toLocaleString();
                document.getElementById('outputTokens').textContent = result.completionTokens.toLocaleString();
                document.getElementById('actualCost').textContent = `$${result.cost.toFixed(6)}`;
                document.getElementById('responseArea').style.display = 'block';

                updateDashboard();
            } catch (error) {
                alert(`Error: ${error.message}`);
                console.error(error);
            } finally {
                button.disabled = false;
                button.textContent = 'Send Message â†’';
            }
        }

        async function callOpenAI(apiKey, model, prompt) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: 'user', content: prompt }]
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'OpenAI API request failed');
            }

            const data = await response.json();
            const pricing = PRICING.openai[model];

            return {
                response: data.choices[0].message.content,
                promptTokens: data.usage.prompt_tokens,
                completionTokens: data.usage.completion_tokens,
                totalTokens: data.usage.total_tokens,
                cost: (data.usage.prompt_tokens * pricing.input) + (data.usage.completion_tokens * pricing.output)
            };
        }

        async function callAnthropic(apiKey, model, prompt) {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: model,
                    max_tokens: 1024,
                    messages: [{ role: 'user', content: prompt }]
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Anthropic API request failed');
            }

            const data = await response.json();
            const pricing = PRICING.anthropic[model];

            return {
                response: data.content[0].text,
                promptTokens: data.usage.input_tokens,
                completionTokens: data.usage.output_tokens,
                totalTokens: data.usage.input_tokens + data.usage.output_tokens,
                cost: (data.usage.input_tokens * pricing.input) + (data.usage.output_tokens * pricing.output)
            };
        }

        async function callCustomAPI(provider, prompt) {
            const response = await fetch(provider.customEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${provider.apiKey}`
                },
                body: JSON.stringify({
                    model: provider.customModel,
                    messages: [{ role: 'user', content: prompt }]
                })
            });

            if (!response.ok) throw new Error('Custom API request failed');

            const data = await response.json();
            const promptTokens = data.usage?.prompt_tokens || 0;
            const completionTokens = data.usage?.completion_tokens || 0;
            const responseText = data.choices?.[0]?.message?.content || data.content?.[0]?.text || JSON.stringify(data);

            return {
                response: responseText,
                promptTokens: promptTokens,
                completionTokens: completionTokens,
                totalTokens: promptTokens + completionTokens,
                cost: (promptTokens * provider.customPricing.input) + (completionTokens * provider.customPricing.output)
            };
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function confirmClearData() {
            if (confirm('Delete all data? This cannot be undone.')) {
                localStorage.removeItem('ai-cost-tracker-providers');
                localStorage.removeItem('ai-cost-tracker-usage');
                closeSettings();
                init();
            }
        }

        function exportData() {
            const data = {
                providers: getData('ai-cost-tracker-providers').map(p => ({ ...p, apiKey: '***REDACTED***' })),
                usage: getData('ai-cost-tracker-usage'),
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai-cost-tracker-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        document.getElementById('promptInput').addEventListener('input', function() {
            const text = this.value;
            const approxTokens = Math.ceil(text.length / 4);
            const select = document.getElementById('modelSelect');
            
            if (select.value) {
                const [providerId, model] = select.value.split('|');
                const providers = getData('ai-cost-tracker-providers');
                const provider = providers.find(p => p.id === providerId);
                
                let pricing;
                if (provider.provider === 'openai') {
                    pricing = PRICING.openai[model];
                } else if (provider.provider === 'anthropic') {
                    pricing = PRICING.anthropic[model];
                } else {
                    pricing = provider.customPricing;
                }
                
                const estimatedCost = approxTokens * pricing.input + (approxTokens * 2 * pricing.output);
                document.getElementById('estimatedCost').textContent = `$${estimatedCost.toFixed(6)}`;
            }
        });

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
