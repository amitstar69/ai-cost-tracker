<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Cost Tracker v1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; }
        .modal.active { display: flex; }
        
        /* Markdown Styles */
        .prose pre { background: #1f2937; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin-top: 0.5rem; }
        .prose code { color: #e9d5ff; font-family: monospace; font-size: 0.9em; }
        .prose p { margin-bottom: 0.75rem; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        .prose strong { color: #fff; font-weight: 600; }

        /* Spinner for streaming */
        .stream-cursor { 
            display: inline-block; width: 0.5em; height: 1.2em; 
            background-color: #fff; animation: blink 0.7s infinite; 
            margin-left: 2px; vertical-align: middle;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen pb-20">

    <header class="border-b border-gray-800 bg-gray-900/50 backdrop-blur-md sticky top-0 z-30">
        <div class="max-w-5xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="text-2xl">üìâ</div>
                <div>
                    <h1 class="text-xl font-bold">AI Cost Tracker <span class="text-xs bg-green-900 text-green-200 px-2 py-0.5 rounded">v1.0</span></h1>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="openFeedbackModal()" class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 rounded text-sm border border-gray-700 transition flex items-center gap-2" title="Send Feedback">
                    <span>üí¨</span> <span class="hidden sm:inline">Feedback</span>
                </button>
                <button onclick="exportData()" class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 rounded text-sm border border-gray-700 transition">Export</button>
                <button onclick="openSettings()" class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 rounded text-sm border border-gray-700 transition">‚öôÔ∏è</button>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-8">
        
        <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-200">Dashboard</h2>
                <select id="statsFilter" onchange="renderUI()" class="bg-gray-900 border border-gray-700 rounded-lg px-3 py-1.5 text-sm text-gray-300 focus:border-purple-500 outline-none">
                    <option value="all">All Providers</option>
                </select>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gray-900 p-5 rounded-xl border border-gray-800">
                    <p class="text-gray-400 text-xs uppercase font-semibold">Today</p>
                    <h3 id="statToday" class="text-2xl font-bold text-white mt-1">$0.00</h3>
                </div>
                <div class="bg-gray-900 p-5 rounded-xl border border-gray-800">
                    <p class="text-gray-400 text-xs uppercase font-semibold">This Month</p>
                    <h3 id="statMonth" class="text-2xl font-bold text-white mt-1">$0.00</h3>
                </div>
                <div class="bg-gray-900 p-5 rounded-xl border border-gray-800">
                    <p class="text-gray-400 text-xs uppercase font-semibold">Requests</p>
                    <h3 id="statRequests" class="text-2xl font-bold text-blue-400 mt-1">0</h3>
                </div>
                <div class="bg-gray-900 p-5 rounded-xl border border-gray-800">
                    <p class="text-gray-400 text-xs uppercase font-semibold">Est. Tokens</p>
                    <h3 id="statTokens" class="text-2xl font-bold text-purple-400 mt-1">0</h3>
                </div>
            </div>

            <div id="costBarContainer" class="hidden">
                <p class="text-xs text-gray-500 mb-2 uppercase font-bold">Cost Distribution (All Time)</p>
                <div id="costBar" class="w-full h-4 bg-gray-800 rounded-full overflow-hidden flex"></div>
                <div id="costLegend" class="flex flex-wrap gap-4 mt-2 text-xs text-gray-400"></div>
            </div>
        </div>

        <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">Connected APIs</h2>
                <button onclick="openAddModal()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm font-medium flex items-center gap-2 shadow-lg shadow-purple-900/20 transition-all hover:scale-105">
                    <span>+</span> Connect API
                </button>
            </div>
            
            <div id="providerList" class="grid gap-3"></div>
            
            <div id="emptyProviders" class="hidden text-center py-12 border-2 border-dashed border-gray-800 rounded-xl bg-gray-900/30">
                <p class="text-gray-500 font-medium">No APIs connected yet.</p>
                <p class="text-gray-600 text-sm mt-1">Connect OpenRouter, Gemini, or Anthropic to start.</p>
            </div>
        </div>

        <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-hidden shadow-2xl mb-8">
            <div class="p-4 border-b border-gray-800 bg-gray-800/50 flex justify-between items-center">
                <h2 class="font-semibold text-gray-200">Playground</h2>
                <div class="flex items-center gap-3">
                    <span id="estCost" class="text-xs text-gray-500 font-mono transition-colors">$0.0000 est.</span>
                    <select id="activeProvider" class="bg-gray-950 border border-gray-700 rounded px-2 py-1.5 text-sm max-w-[200px] text-gray-300 focus:border-purple-500 outline-none">
                        <option value="">Select Provider...</option>
                    </select>
                </div>
            </div>
            
            <div class="p-4">
                <textarea id="promptInput" class="w-full bg-gray-950 text-gray-200 p-4 rounded-lg border border-gray-800 focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none resize-none h-40 font-mono text-sm transition-all" placeholder="Type your prompt here... (Cmd/Ctrl+Enter to send)"></textarea>
                
                <div class="flex justify-end mt-3">
                    <button id="sendBtn" onclick="runPrompt()" class="px-6 py-2.5 bg-white text-black hover:bg-gray-200 font-bold rounded-lg transition flex items-center gap-2 shadow-lg shadow-white/10">
                        Run Request
                    </button>
                </div>
            </div>

            <div id="outputArea" class="hidden border-t border-gray-800 bg-black/20 p-6">
                <div class="flex justify-between text-xs text-gray-500 mb-4 font-mono border-b border-gray-800 pb-2">
                    <span>RESULT</span>
                    <span id="runStats">0 tokens ‚Ä¢ $0.0000</span>
                </div>
                <div id="outputContent" class="prose prose-invert max-w-none text-sm text-gray-300 leading-relaxed min-h-8"></div>
            </div>
        </div>

        <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-hidden shadow-2xl">
            <div class="p-4 border-b border-gray-800 bg-gray-800/50 flex justify-between items-center">
                <h2 class="font-semibold text-gray-200">Recent Activity (Last 10)</h2>
            </div>
            <div id="historyLog" class="p-4 space-y-3"></div>
        </div>

    </main>

    <div id="modalAdd" class="modal fixed inset-0 z-50 items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-gray-900 w-full max-w-md rounded-xl border border-gray-800 shadow-2xl p-6 transition-all">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Connect API</h3>
                <button onclick="closeAddModal()" class="text-gray-500 hover:text-white text-xl">&times;</button>
            </div>
            
            <label class="text-xs text-gray-400 uppercase font-bold block mb-1.5">Provider</label>
            <select id="pType" onchange="updateModalUI()" class="w-full bg-gray-950 border border-gray-700 rounded-lg p-3 mb-4 text-sm focus:border-purple-500 outline-none text-white">
                <option value="openrouter">OpenRouter (Recommended)</option>
                <option value="anthropic">Anthropic (Claude)</option>
                <option value="gemini">Google Gemini</option>
                <option value="openai">OpenAI</option>
                <option value="ollama">Ollama (Local)</option>
                <option value="custom">Custom / Other</option>
            </select>

            <div id="smartModelContainer">
                <label class="text-xs text-gray-400 uppercase font-bold block mb-1.5">Model</label>
                <select id="pPreset" class="w-full bg-gray-950 border border-gray-700 rounded-lg p-3 mb-4 text-sm focus:border-purple-500 outline-none text-white"></select>
                <p class="text-xs text-gray-500 mb-4 -mt-2">Prices are auto-calculated.</p>
            </div>

            <div id="customFields" class="hidden">
                <label class="text-xs text-gray-400 uppercase font-bold block mb-1.5">Model ID</label>
                <input id="pModelRaw" class="w-full bg-gray-950 border border-gray-700 rounded-lg p-3 mb-3 text-sm" placeholder="e.g. llama-3-70b">
                
                <label class="text-xs text-gray-400 uppercase font-bold block mb-1.5">Base URL</label>
                <input id="pUrl" class="w-full bg-gray-950 border border-gray-700 rounded-lg p-3 mb-4 text-sm" placeholder="https://api.example.com/v1">

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase font-bold">Input $/1M</label>
                        <input id="pIn" type="number" class="w-full bg-gray-950 border border-gray-700 rounded p-2 text-sm" placeholder="0.50">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase font-bold">Output $/1M</label>
                        <input id="pOut" type="number" class="w-full bg-gray-950 border border-gray-700 rounded p-2 text-sm" placeholder="1.50">
                    </div>
                </div>
            </div>

            <div id="apiKeyContainer">
                <label class="text-xs text-gray-400 uppercase font-bold block mb-1.5">API Key</label>
                <input id="pKey" type="password" class="w-full bg-gray-950 border border-gray-700 rounded-lg p-3 mb-4 text-sm focus:border-purple-500 outline-none" placeholder="sk-...">
                <p id="anthropicHint" class="hidden text-xs text-yellow-500 mb-2">
                    ‚ö†Ô∏è Note: Browser calls to Anthropic may fail without a proxy. We recommend using OpenRouter for Claude in the browser.
                </p>
            </div>
            
            <div id="healthCheckStatus" class="hidden text-xs text-red-400 bg-red-900/20 p-3 rounded-lg border border-red-900 mb-4 transition-all"></div>

            <button id="modalConnectBtn" onclick="saveProvider()" class="w-full py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold text-white transition shadow-lg shadow-purple-900/20">
                Connect
            </button>
        </div>
    </div>

    <div id="modalSettings" class="modal fixed inset-0 z-50 items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-gray-900 w-full max-w-sm rounded-xl border border-gray-800 p-6">
            <h3 class="text-xl font-bold mb-4">Settings</h3>
            <button onclick="clearUsageOnly()" class="w-full py-3 bg-blue-900/20 text-blue-400 border border-blue-900/50 hover:bg-blue-900/40 rounded-lg mb-3 font-medium transition">
                Clear Usage History Only
            </button>
            <button onclick="clearData()" class="w-full py-3 bg-red-900/20 text-red-400 border border-red-900/50 hover:bg-red-900/40 rounded-lg mb-3 font-medium transition">
                ‚ö†Ô∏è Clear ALL Data (Keys & History)
            </button>
            <button onclick="closeSettings()" class="w-full py-3 bg-gray-800 hover:bg-gray-700 rounded-lg font-medium">
                Close
            </button>
        </div>
    </div>

    <div id="modalFeedback" class="modal fixed inset-0 z-50 items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-gray-900 w-full max-w-md rounded-xl border border-gray-800 shadow-2xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Send Feedback</h3>
                <button onclick="closeFeedbackModal()" class="text-gray-500 hover:text-white text-xl">&times;</button>
            </div>
            <p class="text-sm text-gray-400 mb-4">Found a bug or have a suggestion? Send an email directly to the developer.</p>
            <textarea id="feedbackText" class="w-full bg-gray-950 border border-gray-700 rounded-lg p-4 h-32 text-sm mb-4 focus:border-purple-500 outline-none" placeholder="Describe your issue or idea here..."></textarea>
            <button onclick="sendFeedback()" class="w-full py-3 bg-white text-black hover:bg-gray-200 rounded-lg font-bold transition">
                Draft Email
            </button>
        </div>
    </div>

    <div id="modalAbout" class="modal fixed inset-0 z-50 items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-gray-900 w-full max-w-xl rounded-xl border border-gray-800 shadow-2xl p-6 transition-all">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">About AI Cost Tracker</h3>
                <button onclick="closeAboutModal()" class="text-gray-500 hover:text-white text-xl">&times;</button>
            </div>
            <div class="prose prose-invert text-sm text-gray-300 leading-relaxed">
                <p>The **AI Cost Tracker** is a minimal, client-side tool designed to give you **transparent, real-time control** over your AI service spending.</p>
                
                <h4>üõ°Ô∏è Privacy and Data Security</h4>
                <p>The core principle of this tool is **complete data sovereignty**.</p>
                <ul>
                    <li>**No Cloud Storage:** We do not use any database, server, or cloud service to store your data.</li>
                    <li>**Local Storage Only:** API keys and usage history are stored exclusively in your browser's `localStorage`.</li>
                    <li>**Direct API Calls:** Your browser communicates **directly** with the selected AI provider.</li>
                </ul>
                <p class="text-xs text-gray-500 mt-4">Version 1.0 | Zero Tracking</p>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const DEVELOPER_EMAIL = "amitstar.ch@gmail.com"; 

        // --- PRICING DATABASE ---
        const PRESETS = {
            'openrouter': [
                { id: 'anthropic/claude-3.5-sonnet', name: 'Claude 3.5 Sonnet', in: 3.00, out: 15.00, emoji: 'üî•' },
                { id: 'openai/gpt-4o', name: 'GPT-4o', in: 2.50, out: 10.00, emoji: 'üß†' },
                { id: 'openai/gpt-4o-mini', name: 'GPT-4o Mini', in: 0.15, out: 0.60, emoji: '‚öôÔ∏è' },
                { id: 'google/gemini-flash-1.5', name: 'Gemini Flash 1.5', in: 0.075, out: 0.30, emoji: '‚ö°' },
                { id: 'meta-llama/llama-3.1-70b-instruct', name: 'Llama 3.1 70B', in: 0.4, out: 0.4, emoji: 'ü¶ô' }
            ],
            'anthropic': [
                { id: 'claude-3-5-sonnet-20241022', name: 'Claude 3.5 Sonnet', in: 3.00, out: 15.00, emoji: 'üß†' },
                { id: 'claude-3-5-haiku-20241022', name: 'Claude 3.5 Haiku', in: 0.80, out: 4.00, emoji: '‚ö°' },
                { id: 'claude-3-opus-20240229', name: 'Claude 3 Opus', in: 15.00, out: 75.00, emoji: 'üíé' }
            ],
            'openai': [
                { id: 'gpt-4o', name: 'GPT-4o', in: 2.50, out: 10.00, emoji: 'üß†' },
                { id: 'gpt-4o-mini', name: 'GPT-4o Mini', in: 0.15, out: 0.60, emoji: '‚öôÔ∏è' }
            ],
            'gemini': [
                { id: 'gemini-1.5-flash', name: 'Gemini 1.5 Flash', in: 0.075, out: 0.30, emoji: '‚ö°' },
                { id: 'gemini-1.5-pro', name: 'Gemini 1.5 Pro', in: 3.50, out: 10.50, emoji: 'üöÄ' }
            ],
            'ollama': [
                { id: 'llama3', name: 'Llama 3 (Local)', in: 0, out: 0, emoji: 'üè†' },
                { id: 'mistral', name: 'Mistral (Local)', in: 0, out: 0, emoji: 'üè†' }
            ]
        };

        let providers = JSON.parse(localStorage.getItem('act_providers') || '[]');
        let usage = JSON.parse(localStorage.getItem('act_usage') || '[]');
        const decoder = new TextDecoder("utf-8");
        const TOKEN_EST_FACTOR = 4; 

        /* ---------------- INITIALIZATION ---------------- */
        document.addEventListener('DOMContentLoaded', () => {
            renderUI();
            updateModalUI(); // Initialize the model list on load
            
            document.getElementById('promptInput').addEventListener('input', updateEstimate);
            document.getElementById('activeProvider').addEventListener('change', updateEstimate);

            document.getElementById('promptInput').addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                    e.preventDefault();
                    runPrompt();
                }
            });
        });

        function saveState() {
            localStorage.setItem('act_providers', JSON.stringify(providers));
            localStorage.setItem('act_usage', JSON.stringify(usage));
            renderUI();
        }

        /* ---------------- UI RENDERING ---------------- */
        function renderUI() {
            const filterId = document.getElementById('statsFilter').value;
            let filteredUsage = usage;
            if (filterId !== 'all') filteredUsage = usage.filter(u => u.pid === filterId);

            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            const todayCost = filteredUsage.filter(u => new Date(u.ts) >= todayStart).reduce((a,b) => a + b.cost, 0);
            const monthCost = filteredUsage.filter(u => new Date(u.ts) >= startOfMonth).reduce((a,b) => a + b.cost, 0);
            
            document.getElementById('statToday').innerText = `$${todayCost.toFixed(4)}`;
            document.getElementById('statMonth').innerText = `$${monthCost.toFixed(4)}`;
            document.getElementById('statRequests').innerText = filteredUsage.length.toLocaleString();
            document.getElementById('statTokens').innerText = filteredUsage.reduce((a,b) => a + b.inTok + b.outTok, 0).toLocaleString();

            const filterSelect = document.getElementById('statsFilter');
            const currentFilter = filterSelect.value;
            filterSelect.innerHTML = '<option value="all">All Providers</option>';
            providers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.innerText = p.name;
                filterSelect.appendChild(opt);
            });
            filterSelect.value = currentFilter;

            renderCostBar(usage);
            renderProvidersList();
            renderHistoryLog(filteredUsage);
        }

        function renderCostBar(allUsage) {
            const barContainer = document.getElementById('costBarContainer');
            const bar = document.getElementById('costBar');
            const legend = document.getElementById('costLegend');
            const totalCost = allUsage.reduce((a,b) => a + b.cost, 0);
            
            if (totalCost < 0.0001) { barContainer.classList.add('hidden'); return; }
            barContainer.classList.remove('hidden');
            bar.innerHTML = ''; legend.innerHTML = '';

            const costsByPid = {};
            allUsage.forEach(u => costsByPid[u.pid] = (costsByPid[u.pid] || 0) + u.cost);

            const sorted = Object.entries(costsByPid).sort((a,b) => b[1] - a[1]);
            const top = sorted.slice(0, 3);
            const others = sorted.slice(3);
            const othersCost = others.reduce((a,b) => a + b[1], 0);
            if (othersCost > 0) top.push(['others', othersCost]);

            const colors = ['bg-green-500', 'bg-blue-500', 'bg-purple-500', 'bg-gray-500'];

            top.forEach((item, index) => {
                const percent = (item[1] / totalCost) * 100;
                const pName = item[0] === 'others' ? 'Others' : (providers.find(p => p.id === item[0])?.name || 'Unknown');
                const color = colors[index % colors.length];
                
                const seg = document.createElement('div');
                seg.className = `h-full ${color}`;
                seg.style.width = `${percent}%`;
                bar.appendChild(seg);

                const leg = document.createElement('div');
                leg.className = "flex items-center gap-1";
                leg.innerHTML = `<div class="w-2 h-2 rounded-full ${color}"></div> <span>${pName} (${Math.round(percent)}%)</span>`;
                legend.appendChild(leg);
            });
        }

        function renderProvidersList() {
            const list = document.getElementById('providerList');
            const empty = document.getElementById('emptyProviders');
            const select = document.getElementById('activeProvider');
            list.innerHTML = '';
            const savedVal = select.value;
            select.innerHTML = '<option value="">Select Provider...</option>';

            if (providers.length === 0) { empty.classList.remove('hidden'); } else {
                empty.classList.add('hidden');
                providers.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-900 p-4 rounded-lg border border-gray-800 flex justify-between items-center group hover:border-gray-700 transition';
                    const totalCost = usage.filter(u => u.pid === p.id).reduce((a,b) => a + b.cost, 0);
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 rounded-full bg-gradient-to-br from-gray-800 to-black border border-gray-700 flex items-center justify-center font-bold text-gray-400 text-xs">${p.type.substring(0,3).toUpperCase()}</div>
                            <div><p class="font-bold text-sm text-gray-200">${p.name}</p><p class="text-xs text-gray-500 font-mono">${p.model}</p></div>
                        </div>
                        <div class="text-right"><p class="text-xs text-gray-400 font-mono mb-1">$${totalCost.toFixed(4)}</p><button onclick="deleteProvider('${p.id}')" class="text-xs text-red-900 hover:text-red-400 transition">Remove</button></div>`;
                    list.appendChild(div);
                    
                    const opt = document.createElement('option');
                    opt.value = p.id; opt.innerText = p.name;
                    select.appendChild(opt);
                });
                select.value = savedVal;
            }
        }

        function renderHistoryLog(data) {
            const logDiv = document.getElementById('historyLog');
            const recentUsage = data.slice().sort((a,b) => b.id - a.id).slice(0, 10);
            if (recentUsage.length === 0) { logDiv.innerHTML = '<p class="text-gray-500 text-center text-sm italic">No activity to display.</p>'; return; }

            logDiv.innerHTML = recentUsage.map(u => {
                const p = providers.find(x => x.id === u.pid);
                const date = new Date(u.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                return `<div class="flex justify-between items-center text-xs font-mono bg-gray-950 p-3 rounded-lg border border-gray-800 hover:border-gray-700 transition">
                        <div class="flex flex-col"><span class="text-gray-300 font-semibold">${p ? p.name.split('(')[0] : 'Deleted'}</span><span class="text-gray-500 truncate w-24">${p ? p.model : 'Unknown'}</span></div>
                        <div class="text-right"><span class="text-green-400 font-bold">$${u.cost.toFixed(6)}</span><div class="text-gray-500 mt-0.5">${u.inTok + u.outTok} toks ‚Ä¢ ${date}</div></div></div>`;
            }).join('');
        }
        
        // --- Modal UI Handler (THE FIX) ---
        function updateModalUI() {
            const type = document.getElementById('pType').value;
            const presetSelect = document.getElementById('pPreset');
            const customFields = document.getElementById('customFields');
            const smartModelContainer = document.getElementById('smartModelContainer');
            const anthropicHint = document.getElementById('anthropicHint');

            // Reset UI elements
            presetSelect.innerHTML = '';
            anthropicHint.classList.add('hidden');

            if (type === 'custom') {
                customFields.classList.remove('hidden');
                smartModelContainer.classList.add('hidden');
            } else {
                customFields.classList.add('hidden');
                smartModelContainer.classList.remove('hidden');
                
                if (PRESETS[type]) {
                    PRESETS[type].forEach(model => {
                        const opt = document.createElement('option');
                        opt.value = JSON.stringify({ id: model.id, name: model.name, in: model.in, out: model.out });
                        opt.innerText = `${model.emoji} ${model.name} (${model.id.split('/').pop()})`;
                        presetSelect.appendChild(opt);
                    });
                }
                
                if (type === 'anthropic') {
                    anthropicHint.classList.remove('hidden');
                }
                // Update estimated cost in the main playground when models change/load
                updateEstimate(); 
            }
        }
        
        /* ---------------- LOGIC ---------------- */

        async function saveProvider() {
            const type = document.getElementById('pType').value;
            let name, modelId, inPrice, outPrice, baseUrl, apiKey;
            const btn = document.getElementById('modalConnectBtn');
            const statusDiv = document.getElementById('healthCheckStatus');
            statusDiv.classList.add('hidden');
            btn.disabled = true; btn.innerText = "Testing Connection...";

            if (type === 'custom') {
                modelId = document.getElementById('pModelRaw').value;
                baseUrl = document.getElementById('pUrl').value;
                inPrice = parseFloat(document.getElementById('pIn').value)||0; outPrice = parseFloat(document.getElementById('pOut').value)||0;
                name = `Custom (${modelId})`; apiKey = document.getElementById('pKey').value;
                if (!baseUrl) return showError("Base URL required.");
            } else {
                const presetData = JSON.parse(document.getElementById('pPreset').value);
                modelId = presetData.id; name = presetData.name; inPrice = presetData.in; outPrice = presetData.out;
                if (type === 'ollama') baseUrl = 'http://localhost:11434/v1';
                else if (type === 'openrouter') baseUrl = 'https://openrouter.ai/api/v1';
                else if (type === 'openai') baseUrl = 'https://api.openai.com/v1';
                else if (type === 'anthropic') baseUrl = 'https://api.anthropic.com/v1';
                apiKey = document.getElementById('pKey').value;
            }

            if (type !== 'ollama' && !apiKey) return showError("API Key required.");
            
            const newProvider = { id: Date.now().toString(), type, name, model: modelId, apiKey, baseUrl, inPrice, outPrice, totalCost: 0 };
            const healthCheck = await pingProvider(newProvider);

            if (healthCheck === true) {
                providers.push(newProvider); saveState();
                statusDiv.innerText = "Success!"; statusDiv.className = "text-xs text-green-400 bg-green-900/20 p-3 rounded-lg border border-green-900 mb-4"; statusDiv.classList.remove('hidden');
                setTimeout(() => { closeAddModal(); document.getElementById('pKey').value = ''; statusDiv.classList.add('hidden'); }, 1000);
            } else {
                showError(healthCheck);
            }

            function showError(msg) {
                statusDiv.innerText = msg; statusDiv.className = "text-xs text-red-400 bg-red-900/20 p-3 rounded-lg border border-red-900 mb-4"; statusDiv.classList.remove('hidden');
                btn.disabled = false; btn.innerText = "Retry Connect";
            }
        }

        async function pingProvider(p) {
            try {
                if (p.type === 'gemini') await callGemini(p, 'ping', true);
                else await callStandard(p, 'ping', true);
                return true;
            } catch (e) { return parseApiError(e.message, p.type); }
        }

        async function runPrompt() {
            const pid = document.getElementById('activeProvider').value;
            const prompt = document.getElementById('promptInput').value;
            if (!pid || !prompt) return alert("Select provider and enter prompt.");

            const p = providers.find(x => x.id === pid);
            const btn = document.getElementById('sendBtn');
            const outArea = document.getElementById('outputArea');
            const outContent = document.getElementById('outputContent');
            const runStats = document.getElementById('runStats');
            
            btn.innerHTML = "Thinking... ‚ö°Ô∏è"; btn.disabled = true;
            outArea.classList.remove('hidden'); outContent.innerHTML = '<span class="animate-pulse text-gray-500">Connecting...</span>';
            outArea.scrollIntoView({ behavior: 'smooth', block: 'start' });

            let inTok = 0, outTok = 0, cost = 0;

            try {
                if (p.type === 'gemini') {
                    const streamResponse = await callGemini(p, prompt, false);
                    outContent.innerHTML = '';
                    const result = await streamGeminiResponse(streamResponse, outContent);
                    inTok = Math.ceil(prompt.length / TOKEN_EST_FACTOR);
                    outTok = result.usageMetrics.completion_tokens;
                } else {
                    const streamResult = await callStandard(p, prompt, false);
                    outContent.innerHTML = '';
                    const result = await streamStandardResponse(streamResult, outContent);
                    inTok = result.usageMetrics?.prompt_tokens || Math.ceil(prompt.length / TOKEN_EST_FACTOR);
                    outTok = result.usageMetrics?.completion_tokens || Math.ceil(result.text.length / TOKEN_EST_FACTOR);
                }
                cost = (inTok / 1e6 * p.inPrice) + (outTok / 1e6 * p.outPrice);
                runStats.innerText = `In: ${inTok} ‚Ä¢ Out: ${outTok} ‚Ä¢ Cost: $${cost.toFixed(6)}`;
                usage.push({ id: Date.now(), pid: p.id, ts: new Date().toISOString(), inTok, outTok, cost });
                saveState();
            } catch (e) {
                outContent.innerHTML = `<div class="bg-red-900/20 border border-red-800 text-red-300 p-4 rounded-lg text-sm"><strong>Request Failed:</strong> ${parseApiError(e.message, p.type)}</div>`;
            } finally { btn.innerHTML = "Run Request"; btn.disabled = false; }
        }

        // --- API HANDLERS ---
        async function callGemini(p, prompt, isPing) {
            const endpoint = isPing ? 'generateContent' : 'streamGenerateContent?alt=sse';
            const modelPath = p.model.includes('/') ? p.model.replace(/\//g, '-') : p.model;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelPath}:${endpoint}&key=${p.apiKey}`;
            const body = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { maxOutputTokens: isPing ? 1 : undefined } };
            const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            if (!r.ok) { const t = await r.text(); throw new Error(`Status: ${r.status} - ${t}`); }
            return isPing ? true : r;
        }

        async function streamGeminiResponse(response, outputElement) {
            const reader = response.body.getReader();
            let fullText = "";
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const lines = decoder.decode(value).split('\n');
                for (const line of lines) {
                    if (line.startsWith('data:')) {
                        try {
                            const json = JSON.parse(line.substring(5));
                            const textPart = json.candidates?.[0]?.content?.parts?.[0]?.text;
                            if (textPart) { fullText += textPart; outputElement.innerHTML = marked.parse(fullText + '<span class="stream-cursor"></span>'); }
                        } catch (e) {}
                    }
                }
            }
            outputElement.innerHTML = marked.parse(fullText);
            return { text: fullText, usageMetrics: { completion_tokens: Math.ceil(fullText.length / 4) } };
        }

        async function callStandard(p, prompt, isPing) {
            const url = p.baseUrl.endsWith('/') ? `${p.baseUrl}chat/completions` : `${p.baseUrl}/chat/completions`;
            const headers = { "Content-Type": "application/json" };
            if (p.apiKey && p.type !== 'anthropic') headers["Authorization"] = `Bearer ${p.apiKey}`;
            if (p.type === 'openrouter') { headers["HTTP-Referer"] = window.location.href; headers["X-Title"] = "AI Cost Tracker"; }
            if (p.type === 'anthropic') {
                 headers["x-api-key"] = p.apiKey; headers["anthropic-version"] = "2023-06-01"; headers["anthropic-dangerous-direct-browser-access"] = "true";
            }
            const body = { model: p.model, messages: [{ role: "user", content: prompt }], stream: !isPing, max_tokens: isPing ? 1 : undefined };
            const r = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });
            if (!r.ok) { const t = await r.text(); throw new Error(`Status: ${r.status} - ${t}`); }
            return isPing ? true : r;
        }

        async function streamStandardResponse(response, targetElement) {
            const reader = response.body.getReader();
            let fullText = ""; let usageMetrics = null;
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const lines = decoder.decode(value).split('\n');
                for (const line of lines) {
                    if (line.startsWith('data:')) {
                        const data = line.substring(5).trim();
                        if (data === '[DONE]') continue;
                        try {
                            const json = JSON.parse(data);
                            const content = json.choices?.[0]?.delta?.content || json.choices?.[0]?.text || '';
                            if (content) { fullText += content; targetElement.innerHTML = marked.parse(fullText + '<span class="stream-cursor"></span>'); }
                            if (json.usage) usageMetrics = json.usage;
                        } catch (e) {}
                    }
                }
            }
            targetElement.innerHTML = marked.parse(fullText);
            return { text: fullText, usageMetrics };
        }

        // Helpers
        function updateEstimate() {
            const text = document.getElementById('promptInput').value;
            const pid = document.getElementById('activeProvider').value;
            const display = document.getElementById('estCost');
            if (!text || !pid) { display.innerText = '$0.0000 est.'; return; }
            const p = providers.find(x => x.id === pid);
            const tokens = Math.ceil(text.length / 4);
            const cost = (tokens / 1e6) * p.inPrice;
            display.innerText = `~${tokens} toks ‚Ä¢ $${cost.toFixed(6)} est.`;
        }

        function parseApiError(errorText, type) {
            if (errorText.includes('401') || errorText.includes('403')) return `**Access Denied**: Check your API Key.`;
            if (errorText.includes('404')) return `**Not Found**: Check Model ID or URL.`;
            if (errorText.includes('Failed to fetch')) return `**Network Error**: Likely CORS. Use OpenRouter or Proxy.`;
            return errorText.substring(0, 100);
        }

        function openAddModal() { document.getElementById('modalAdd').classList.add('active'); updateModalUI(); }
        function closeAddModal() { document.getElementById('modalAdd').classList.remove('active'); document.getElementById('modalConnectBtn').innerText="Connect"; document.getElementById('modalConnectBtn').disabled=false; }
        function openSettings() { document.getElementById('modalSettings').classList.add('active'); }
        function closeSettings() { document.getElementById('modalSettings').classList.remove('active'); }
        function openAboutModal() { document.getElementById('modalAbout').classList.add('active'); }
        function closeAboutModal() { document.getElementById('modalAbout').classList.remove('active'); }
        function openFeedbackModal() { document.getElementById('modalFeedback').classList.add('active'); }
        function closeFeedbackModal() { document.getElementById('modalFeedback').classList.remove('active'); }
        
        function deleteProvider(id) { if(confirm('Remove?')) { providers = providers.filter(p=>p.id!==id); saveState(); }}
        function clearData() { if(confirm('Delete ALL?')) { providers=[]; usage=[]; saveState(); closeSettings(); }}
        function clearUsageOnly() { if(confirm('Clear history?')) { usage=[]; saveState(); closeSettings(); }}
        
        function sendFeedback() {
            const text = document.getElementById('feedbackText').value;
            const subject = encodeURIComponent("AI Cost Tracker Feedback");
            const body = encodeURIComponent(text);
            window.location.href = `mailto:${DEVELOPER_EMAIL}?subject=${subject}&body=${body}`;
        }

        function exportData() {
            const blob = new Blob([JSON.stringify({providers, usage}, null, 2)], {type : 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ai_tracker_backup.json';
            a.click();
        }
    </script>
</body>
</html>
